!function(e){"use strict";e.module("gma",["ngRoute","ui.bootstrap","ngResource","gma.controllers","gma.directives","gma.filters","gma.services","ngDragDrop","angular-growl","gettext"])}(angular),function(e){"use strict";e.module("gma.controllers",["gma.controllers.admin","gma.controllers.error","gma.controllers.map","gma.controllers.measurements","gma.controllers.reports","gma.controllers.preference","gma.controllers.stories"])}(angular),function(e){"use strict";e.module("gma.directives",[])}(angular),function(e){"use strict";e.module("gma.filters",[])}(angular),function(e){"use strict";e.module("gma.services",["gma.services.googleAnalytics","gma.services.measurements","gma.services.settings","gma.services.preference","gma.services.stories"])}(angular),function(e){"use strict";e.module("gma.controllers.admin",["gettext"])}(angular),function(e){"use strict";e.module("gma.controllers.error",[])}(angular),function(e){"use strict";e.module("gma.controllers.map",[])}(angular),function(e){"use strict";e.module("gma.controllers.measurements",[])}(angular),function(e){"use strict";e.module("gma.controllers.preference",[])}(angular),function(e){"use strict";e.module("gma.controllers.reports",[])}(angular),function(e){"use strict";e.module("gma.controllers.stories",[])}(angular),function(e){"use strict";e.module("gma.services.googleAnalytics",[])}(angular),function(e){"use strict";e.module("gma.services.measurements",[])}(angular),function(e){"use strict";e.module("gma.services.preference",[])}(angular),function(e){"use strict";e.module("gma.services.settings",["gettext"])}(angular),function(e){"use strict";e.module("gma.services.stories",[])}(angular),function(){"use strict";angular.module("gma").run(["$rootScope","$route","$location","Session","Settings","GoogleAnalytics",function(e,t,n,r,i,a){if(e.current={isLoaded:!1},a.init(),"undefined"!=typeof window.parent){var o=window.parent.location.hash;o&&n.path(o.slice(1)),e.$on("$locationChangeSuccess",function(){window.parent.location.hash="#"+n.path()})}t.reload(),r.startSession(i.ticket)}]).config(["$routeProvider","$httpProvider","$compileProvider","SettingsProvider","$provide","growlProvider","$rootScopeProvider",function(e,t,n,r,i,a,o){r.setConfig(window.gma.config),n.aHrefSanitizationWhitelist(/^\s*(https?|ftp|mailto|tel|file|itms-services):/),n.imgSrcSanitizationWhitelist(/^\s*(https?|ftp|file|data|blob):/),t.interceptors.push("Session"),o.digestTtl(100),a.globalPosition("top-right"),a.globalTimeToLive({success:5e3,error:1e4,warning:1e4,info:5e3}),a.globalDisableCountDown(!0),angular.forEach(r.routes(),function(t,n){0===n&&e.otherwise({redirectTo:t.path}),e.when(t.path,{templateUrl:t.templateUrl,controller:t.controller})}),e.when("/error/:reason",{templateUrl:"partials/error/error.html",controller:"ErrorCtrl"}),i.decorator("ngModelDirective",["$delegate",function(e){var t=e[0],n=t.controller;return t.controller=["$scope","$element","$attrs","$injector",function(e,t,r,i){var a=i.get("$interpolate");r.$set("name",a(r.name||"")(e)),i.invoke(n,this,{$scope:e,$element:t,$attrs:r})}],e}]),i.decorator("formDirective",["$delegate",function(e){var t=e[0],n=t.controller;return t.controller=["$scope","$element","$attrs","$injector",function(e,t,r,i){var a=i.get("$interpolate");r.$set("name",a(r.name||r.ngForm||"")(e)),i.invoke(n,this,{$scope:e,$element:t,$attrs:r})}],e}])}])}(),function(e){"use strict";function t(t,n,r,i,a,o,s,c,u,l,m,d,g,p,f){function h(t){var n=[];return e.forEach(t,function(e){n.push(e),e.hasOwnProperty("sub_ministries")&&"object"==typeof e.sub_ministries&&(n=n.concat(h(e.sub_ministries)))}),n=_.sortBy(n,function(e){return"leader"===e.team_role?0:1}),_.uniq(n,!1,function(e){return e.ministry_id})}function y(){window.setTimeout(function(){window.parent.scrollTo(0,0)},10)}t.$location=r,t.mobileApps=c.mobileApps,t.tabs=c.tabs,t.langFlagClass="flag-us",r.path("/map").replace(),t.appEnvironment=c.appEnvironment,t.appName=c.name,t.appVersion=c.version,t.$on("sessionStart",function(e,n){("undefined"==typeof n.assignments||0==n.assignments.length)&&t.joinMinistry(!1)}),t.$watch("current.assignments",function(i,a){if(i!==a)if(u.debug("Assignments Changed"),"object"==typeof i&&"undefined"==typeof a){var o=!1;if(t.current.hasOwnProperty("user_preferences")&&"undefined"!=typeof t.current.user_preferences){var s=m.getFlatMinistry(i),c=_.find(s,function(e){return e.ministry_id===t.current.user_preferences.preferred_ministry});o="undefined"!=typeof c&&""!=typeof c?c:n("orderBy")(i,"name")[0]}else o=n("orderBy")(i,"name")[0];if(o!==!1)if(_.contains(["admin","inherited_admin","leader","inherited_leader","member"],o.team_role)){r.path("/news").replace();var l=t.$on("$routeChangeSuccess",function(){o!==!1&&(t.current.assignment=o,o=!1,l())})}else t.current.assignment=o;t.current.ministries=h(i)}else"object"==typeof i?((e.isUndefined(t.current.assignment)||!_.contains(_.pluck(i,"id"),t.current.assignment.id))&&(t.current.assignment=n("orderBy")(i,"name")[0]),t.current.ministries=h(i)):(delete t.current.assignment,t.current.ministries=[])}),t.$watch("current.assignment",function(e,r){if(e!==r&&(u.debug("Assignment Changed: "+e.name),"object"==typeof e))if(e.mccs.length>0)if("undefined"==typeof r)if(t.current.hasOwnProperty("user_preferences")&&"undefined"!=typeof t.current.user_preferences){var i=_.find(e.mccs,function(e){return e===t.current.user_preferences.preferred_mcc});if("undefined"!=typeof i&&""!=typeof i)t.current.mcc=i;else{var a=_.find(e.mccs,function(e){return e===t.current.assignment.default_mcc});"undefined"!=typeof a&&""!==a?t.current.mcc=a:t.current.mcc=n("orderBy")(e.mccs,t.mccSort)[0]}}else("undefined"==typeof t.current.mcc||e.mccs.indexOf(t.current.mcc)<0)&&(t.current.mcc=n("orderBy")(e.mccs,t.mccSort)[0]);else("undefined"==typeof t.current.mcc||e.mccs.indexOf(t.current.mcc)<0)&&(t.current.mcc=n("orderBy")(e.mccs,t.mccSort)[0]);else delete t.current.mcc}),t.$watch("current.assignment.mccs",function(e,r){void 0!==e&&0!==e.length?("undefined"==typeof t.current.mcc||e.indexOf(t.current.mcc)<0)&&(t.current.mcc=n("orderBy")(e,t.mccSort)[0]):delete t.current.mcc},!0),t.current.hasRole=function(e){return"undefined"==typeof t.current.assignment||"undefined"==typeof t.current.assignment.team_role?!1:"string"==typeof e?e==t.current.assignment.team_role:_.contains(e,t.current.assignment.team_role)},t.mccLabels={ds:f("Digital Strategies"),gcm:f("Global Church Movements"),llm:f("Leader Led"),slm:f("Student Led")},t.mccSort=function(e){return t.mccLabels[e]};for(var v=[],w=moment().date(1),b=0;12>b;b++)v.push(w.clone()),w.subtract(1,"M");t.periods=v,t.current.period=v[0],t.prevPeriod=function(){var e=t.periods.indexOf(t.current.period);e=e+1>=t.periods.length?0:e+1,t.current.period=t.periods[e]},t.nextPeriod=function(){var e=t.periods.indexOf(t.current.period);e=0>e-1?t.periods.length-1:e-1,t.current.period=t.periods[e]},t.logout=function(){a.logout().then(function(){window.location=c.api.logout})},t.invalidateSession=function(){a.logout()},t.joinMinistry=function(e){e="undefined"!=typeof e?e:!0;var n=i.open({templateUrl:"partials/join-ministry.html",controller:"JoinMinistryCtrl",keyboard:e,backdrop:e?!0:"static",resolve:{ministries:function(){return o.getMinistries().$promise},allowClose:function(){return e}}});n.result.then(function(e){s.addTeamMember({username:t.current.user.cas_username,ministry_id:e.ministry.ministry_id,team_role:"self_assigned"},function(n){"undefined"==typeof t.current.assignments||t.current.assignments===[]?(t.current.assignments=[n],m.savePreference(e.user_preference).success(function(){"undefined"==typeof t.current.user_preferences&&(t.current.user_preferences={}),t.current.user_preferences.supported_staff=e.user_preference.supported_staff})):(t.current.assignments.push(n),t.current.assignment=n),l.event("assignments","join ministry",function(){var e={};return e[l.DIM.guid]=t.current.user.key_guid,e[l.DIM.ministry_id]=n.ministry_id,e}())},function(e){400===e.status?d.error(p.getString("You are already assigned to requested ministry")):d.error(p.getString("Unable to join to requested ministry"))})}),y()},t.onError=function(e,t){r.path("/error")},t.showUserPreference=function(){i.open({templateUrl:"partials/preference/user-preference-modal.html",controller:"UserPreferenceCtrl",keyboard:!0,backdrop:!0,size:"model-lg",resolve:{modelData:function(){return{mccLabels:e.copy(t.mccLabels)}}}}),y()},t.$watch("current.user_preferences.static_locale",function(e,n){if("undefined"!=typeof e&&""!==e){var r=e.replace("-","_"),i=function(e,n){var a=-1!=n?e.substring(0,n):e;p.loadRemote("languages/"+a+".json").success(function(o){p.setStrings(r,o[a.replace("-","_")]),-1!=n?i(e,e.indexOf("-",n+1)):(t.langFlagClass="flag-"+e.split("-")[1].toLowerCase(),p.setCurrentLanguage(r))}).error(function(a){-1!=n?i(e,e.indexOf("-",n+1)):(t.langFlagClass="flag-"+e.split("-")[1].toLowerCase(),p.setCurrentLanguage(r))})};i(e,e.indexOf("-"))}}),t.tabFilter=function(e){return"undefined"==typeof t.current?!1:t.current.hasRole(e.requiredRoles)?"/reports"==e.path?"undefined"==typeof t.current.user_preferences?"1"!=t.current.hide_reports_tab:"1"!==t.current.user_preferences.hide_reports_tab:"/measurements"==e.path?"undefined"!=typeof t.current.mcc:!0:!1},t.$on("$locationChangeStart",function(e,n,r){if(void 0===t.current.assignment)return!0;var i=n.split("#/")[1],a=_.findWhere(t.tabs,{path:"/"+i});return"undefined"==typeof a||t.current.hasRole(a.requiredRoles)?void 0:(d.error(p.getString("You are not authorised for this")),e.preventDefault(),!1)}),t.current.redirectToHomeTab=function(){t.current.hasRole(["admin","inherited_admin","leader","inherited_leader"])?r.path("/news").replace():r.path("/map").replace()},t.current.canAccessCurrentTab=function(){return"undefined"==typeof t.current.assignment?!1:t.current.hasRole(_.findWhere(t.tabs,{path:r.path()}).requiredRoles)},t.current.loadLanguages=function(){return"undefined"!=typeof t.current.langList&&0!==t.current.langList.length?t.current.langList:void g.getLanguages().success(function(e){return t.current.langList=_.sortBy(e,"english_name"),t.current.langList}).error(function(){return d.error(p.getString("Unable to load languages")),!1})}}t.$inject=["$scope","$filter","$location","$modal","Session","Ministries","Assignments","Settings","$log","GoogleAnalytics","UserPreference","growl","Languages","gettextCatalog","gettext"],e.module("gma.controllers").controller("GMACtrl",t)}(angular),function(){"use strict";function e(e,t,n,r,i){e.ministries=n,e.allowClose=r,i.screen("Join Ministry",function(){var t={};return t[i.DIM.guid]=e.current.user.key_guid,t}()),window.setTimeout(function(){window.parent.scrollTo(0,0)},10),e.join=function(){var n={};n.ministry=e.ministry,n.user_preference=e.user_preference,t.close(n)},e.cancel=function(){t.dismiss("cancel")}}e.$inject=["$scope","$modalInstance","ministries","allowClose","GoogleAnalytics"],angular.module("gma.controllers").controller("JoinMinistryCtrl",e)}(),function(){"use strict";angular.module("gma.directives").directive("gmaTrend",[function(){return{restrict:"A",require:"ngModel",link:function(e,t,n,r){if(r){var i=new google.visualization.LineChart(t.get(0));r.$render=function(){i.draw(r.$viewValue,{width:550,height:200,chartArea:{width:"65%"}})},e.$on("$destroy",function(){i=null})}}}}])}(),function(e){e.module("gma.directives").directive("imageResizer",["$q",function(t){"use strict";function n(e){for(var t=atob(e.split(",")[1]),n=new ArrayBuffer(t.length),r=new Uint8Array(n),i=e.split(",")[0].split(":")[1].split(";")[0],a=0;a<t.length;a++)r[a]=t.charCodeAt(a);return new Blob([n],{type:i})}var r=window.URL||window.webkitURL,i=function(){var e="fileupload-resize-area",t=document.getElementById(e);return t||(t=document.createElement("canvas"),t.id=e,t.style.visibility="hidden",document.body.appendChild(t)),t},a=function(e,t){var n=t.resizeMaxHeight||128,r=t.resizeMaxWidth||128,a=t.resizeQuality||.8,o=t.resizeType||"image/jpg",s=i(),c=e.height,u=e.width;u>c?u>r&&(c=Math.round(c*=r/u),u=r):c>n&&(u=Math.round(u*=n/c),c=n),s.width=u,s.height=c;var l=s.getContext("2d");return l.drawImage(e,0,0,u,c),s.toDataURL(o,a)},o=function(e,t){var n=new Image;n.onload=function(){t(n)},n.src=e},s=function(e){var n=t.defer(),r=new FileReader;return r.onload=function(e){n.resolve(e.target.result)},r.readAsDataURL(e),n.promise};return{restrict:"A",require:"ngModel",scope:{imageModel:"=",resizeMaxHeight:"@?",resizeMaxWidth:"@?",resizeQuality:"@?",resizeType:"@?"},link:function(t,i,c,u){var l=function(e,r){o(e.url,function(i){var o=a(i,t),s=n(o);e.resized={blob:s,dataURL:o,type:o.match(/:(.+\/.+);/)[1]},r(e)})},m=function(e){t.$apply(function(){t.imageModel=e})},d=function(e){t.$apply(function(){u.$setValidity("invalidImage",e)})};i.bind("change",function(n){var i=n.target.files;if(0===i.length)return m({}),n.preventDefault(),n.stopPropagation(),!1;if(null===i[0].type.match("image/*"))return e.element(n.target).val(""),m({}),d(!1),n.preventDefault(),!1;d(!0);var a={file:i[0],url:r.createObjectURL(i[0])};s(i[0]).then(function(e){a.dataURL=e}),t.resizeMaxHeight||t.resizeMaxWidth?l(a,function(e){m(e)}):m(a)})}}}])}(angular),function(){"use strict";angular.module("gma.filters").filter("mccFilter",[function(){return function(e,t){var n=[];return"undefined"==typeof t||"undefined"==typeof e?n:(angular.forEach(e,function(e){-1!==t.indexOf(e.value)&&n.push(e)}),n)}}])}(),function(){"use strict";angular.module("gma.filters").filter("roleFilter",[function(){return function(e,t){var n=[];return angular.forEach(e,function(e){"string"==typeof t&&t==e.team_role?n.push(e):"object"==typeof t&&_.contains(t,e.team_role)&&n.push(e)}),n}}])}(),function(){"use strict";function e(e,t,n,r,i,a,o,s,c,u,l){function m(){window.setTimeout(function(){window.parent.scrollTo(0,0)},10)}function d(t){var r=n.open({templateUrl:"partials/admin/confirm-member-drop.html",controller:["$scope","$modalInstance","modalData",function(e,t,n){e.member=n.member,e.team=n.team,e.yes=function(){t.close()},e.no=function(){t.dismiss("cancel")},e.getRoleName=function(e){return p(e)}}],resolve:{modalData:function(){return{member:e.draggedMember,team:t}}}});return m(),r.result}function g(t){var r=n.open({templateUrl:"partials/admin/confirm-team-drop.html",controller:["$scope","$modalInstance","modalData",function(e,t,n){e.source_team=n.source,e.target_team=n.target,e.yes=function(){t.close()},e.no=function(){t.dismiss("cancel")}}],resolve:{modalData:function(){return{source:e.draggedTeam.name,target:t.name}}}});return m(),r.result}function p(t){var n=_.find(e.roles,function(e){return e.value===t});return void 0!==n?n.text:t}function f(e,t){var n=c.getFlatMinistry(angular.copy(e.sub_ministries)),r=_.find(n,function(e){return e.ministry_id===t.ministry_id});return void 0!==r}e.current.isLoaded=!1;var h=_.throttle(function(){a.screen("Admin",function(){var t={};return t[a.DIM.guid]=e.current.user.key_guid,t[a.DIM.ministry_id]=e.current.assignment.ministry_id,t}())},1e3,{leading:!1});e.$watch("current.assignment.ministry_id",function(t){"undefined"!=typeof t&&(e.current.canAccessCurrentTab()?(e.current.hasRole(["admin","inherited_admin"])||e.selectTab("team-members"),h(),e.current.isLoaded=!1,e.ministry=o.getMinistry({ministry_id:t},function(){e.current.isLoaded=!0,e.initTeamAndMembers(),e.current.hasRole(["admin","inherited_admin"])&&(e.measurementTypes=[],e.current.loadLanguages(),i.getMeasurementTypes({ministry_id:t}).$promise.then(function(t){angular.forEach(t,function(t){t.is_custom&&_.contains(e.ministry.lmi_show,t.perm_link_stub)?t.visible=!0:t.is_custom||_.contains(e.ministry.lmi_hide,t.perm_link_stub)?t.visible=!1:t.visible=!0,e.measurementTypes.push(t)})}))})):e.current.redirectToHomeTab())}),e.initSubTabs=function(){e.adminTabTemplates=y(),"undefined"==typeof e.activePill&&(e.activePill="team-members"),e.selectTab(e.activePill)},e.selectTab=function(t){e.activePill=t,"undefined"==typeof t&&(e.activePill="team-members"),e.currentAdminTab=_.find(y(),function(e){return e.name===t})};var y=function(){return[{url:"partials/admin/_team-members.html",name:"team-members",label:l("Team & Members"),requiredRoles:["admin","inherited_admin","leader","inherited_leader"]},{url:"partials/admin/_edit-ministry.html",name:"edit-ministry",label:l("Edit Ministry"),requiredRoles:["admin","inherited_admin"]},{url:"partials/admin/_measurement.html",name:"measurement",label:l("Manage Measurements"),requiredRoles:["admin","inherited_admin"]}]};e.mccs=[{value:"ds",text:"Digital Strategies",checked:!1},{value:"gcm",text:"Global Church Movements",checked:!1},{value:"llm",text:"Leader Led",checked:!1},{value:"slm",text:"Student Led",checked:!1}],e.ableToChangeParentMinistry=function(n){var r=_.pluck(t("roleFilter")(e.current.ministries,["admin","inherited_admin","leader","inherited_leader"]),"ministry_id");return _.contains(r,n)},e.getMCCValue=function(t){return _.contains(e.ministry.mccs,t)},e.createMCCArray=function(t,n){if(t)-1===e.ministry.mccs.indexOf(n)&&e.ministry.mccs.push(n);else{var r=e.ministry.mccs.indexOf(n);-1!==r&&e.ministry.mccs.splice(r,1)}},e.saveDetails=function(){0==_.size(e.mccs)&&(e.ministry.default_mcc="");var t={ministry_id:e.ministry.ministry_id,min_code:e.ministry.min_code,name:e.ministry.name,mccs:e.ministry.mccs,content_locales:e.ministry.content_locales,"private":e.ministry["private"],hide_reports_tab:e.ministry.hide_reports_tab,default_mcc:e.ministry.default_mcc,lmi_hide:_.pluck(_.where(e.measurementTypes,{is_custom:!1,visible:!1}),"perm_link_stub"),lmi_show:_.pluck(_.where(e.measurementTypes,{is_custom:!0,visible:!0}),"perm_link_stub")};e.ministry.hasOwnProperty("parent_id")&&"string"==typeof e.ministry.parent_id&&(t.parent_id=e.ministry.parent_id),e.saveDetailsResource=o.updateMinistry(t,function(){e.current.assignment.name=angular.copy(t.name),e.current.assignment.mccs=angular.copy(t.mccs),e.current.assignment.content_locales=angular.copy(t.content_locales),s.success(u.getString("Changes saved successfully"))},function(e){s.error(u.getString("Unable to save changes"))})},e.addNewMeasurement=function(){n.open({templateUrl:"partials/admin/add-measurement-type.html",controller:["$scope","$modalInstance",function(e,t){e.newMeasurement={},e.close=function(){t.dismiss("cancel")},e.add=function(){t.close(e.newMeasurement)}}]}).result.then(function(t){i.addMeasurementType(t,function(t){s.success(u.getString("Measurement was created successfully"));var n=angular.fromJson(angular.toJson(t));n.visible=!1,e.measurementTypes.push(n)},function(){s.error(u.getString("Unable to create measurement"))})}),m()},e.editMeasurement=function(t){n.open({templateUrl:"partials/admin/edit-measurement-type.html",controller:["$scope","$modalInstance","modalData",function(e,t,n){e.measurement={},e.isLocaleLoaded=!0,e.contentLocales=n.contentLocales,e.original=n.measurement,e.measurement.locale=n.supportedLanguages[0],e.close=function(){t.dismiss("cancel")},e.filterByLangCode=function(e){return _.contains(n.supportedLanguages,e.iso_code)?e:!1},e.save=function(){t.close(e.measurement)},e.changeLocale=function(t){return void 0===t||""===t?!1:(e.isLocaleLoaded=!1,void i.getMeasurementType({measurement_type_id:n.measurement.perm_link_stub,ministry_id:n.ministry_id,locale:t},function(t){e.measurement.localized_name=t.localize_name||t.localized_name,e.measurement.localized_description=t.localize_description||t.localized_description,e.isLocaleLoaded=!0},function(){s.error(u.getString("Unable to get measurement")),e.isLocaleLoaded=!0}))},e.changeLocale(e.measurement.locale)}],resolve:{modalData:function(){return{measurement:angular.copy(t),ministry_id:e.current.assignment.ministry_id,contentLocales:e.availableLanguages,supportedLanguages:e.ministry.content_locales||{}}}}}).result.then(function(n){n.measurement_type_id=t.perm_link_stub,n.ministry_id=e.current.assignment.ministry_id,i.updateMeasurementType(n,function(e){s.success(u.getString("Measurement was updated"))},function(){s.error(u.getString("Unable to update measurement"))})}),m()},e.roles=[{value:"admin",text:l("Admin")},{value:"inherited_admin",text:l("Admin (inherited)")},{value:"leader",text:l("Leader")},{value:"inherited_leader",text:l("Leader (inherited)")},{value:"member",text:l("Member")},{value:"blocked",text:l("Deleted")},{value:"former_member",text:l("Former Member")},{value:"self_assigned",text:l("Self Assigned")}],e.initTeamAndMembers=function(){e.allCurrentTeams=[],e.allCurrentTeams.push(angular.copy(e.current.assignment)),e.activeTeamMembers={},e.ministry.hasOwnProperty("team_members")&&(e.activeTeamMembers=angular.copy(e.ministry.team_members)),e.activeTeam=angular.copy(e.current.assignment),e.membersLoaded=!0},e.setActiveTeam=function(t){return e.activeTeam.ministry_id===t.ministry_id?!1:(e.activeTeam=t,void e.loadMinistryMembers(t.ministry_id))},e.loadMinistryMembers=function(t){e.membersLoaded=!1,o.getMinistry({ministry_id:t},function(t){e.activeTeamMembers=t.team_members,e.membersLoaded=!0},function(){s.error(u.getString("Unable to load team members")),e.membersLoaded=!0})},e.filter={memberSearch:"",inheritedLeader:!0,inheritedAdmin:!0,deletedUser:!1,formerMember:!1,checkFormer:function(t){return e.filter.formerMember?!0:"former_member"!=t.team_role},checkDeleted:function(t){return e.filter.deletedUser?!0:"blocked"!=t.team_role},checkLeader:function(t){return e.filter.inheritedLeader?!0:"inherited_leader"!=t.team_role},checkAdmin:function(t){return e.filter.inheritedAdmin?!0:"inherited_admin"!=t.team_role}},e.addNewTeamMember=function(){n.open({templateUrl:"partials/admin/add-team-member.html",controller:["$scope","$modalInstance","modalData",function(e,t,n){e.roles=n.roles,e.activeTeamName=n.activeTeam,e.close=function(){t.dismiss()},e.add=function(){t.close(e.newMember)}}],resolve:{modalData:function(){return{roles:e.roles,activeTeam:e.activeTeam.name}}}}).result.then(function(t){return"undefined"==typeof t?!1:(t.ministry_id=e.activeTeam.ministry_id,void r.addTeamMember(t,function(t){s.success(u.getString("New member was added successfully")),e.loadMinistryMembers(e.activeTeam.ministry_id)},function(e){404===e.status?s.error(u.getString("Failed, User not found")):s.error(u.getString("Unable to add new member"))}))}),m()},e.updateUserRole=function(t,i){return t===i.team_role?!1:(n.open({templateUrl:"partials/admin/confirm-update-role.html",controller:["$scope","$modalInstance","userInfo",function(e,t,n){e.userInfo=n,e.no=function(){t.dismiss()},e.yes=function(){t.close(!0)},e.getRoleName=function(e){return p(e)}}],resolve:{userInfo:function(){return{old_role:angular.copy(t),user:angular.copy(i)}}}}).result.then(function(n){if("undefined"!=typeof i.assignment_id&&""!==i.assignment_id.trim())r.saveAssignment({assignment_id:i.assignment_id},{team_role:i.team_role},function(){s.success(u.getString("User role was updated")),t=i.team_role},function(){s.error(u.getString("Unable to update user role")),i.team_role=t});else{var a={ministry_id:e.activeTeam.ministry_id,key_guid:i.key_guid||"",username:i.key_username||"",team_role:i.team_role};r.addTeamMember(a,function(t){s.success(u.getString("User role was updated")),e.loadMinistryMembers(e.activeTeam.ministry_id)},function(){s.error(u.getString("Unable to update user role")),i.team_role=t})}},function(){i.team_role=t}),void m())},e.addNewSubMinistry=function(){n.open({templateUrl:"partials/admin/add-sub-ministry.html",controller:["$scope","$modalInstance","modalData",function(e,t,n){e.newMinistry={},e.activeTeamName=n.activeTeam,e.close=function(){t.dismiss()},e.add=function(){t.close(e.newMinistry)}}],resolve:{modalData:function(){return{activeTeam:e.activeTeam.name}}}}).result.then(function(t){return"undefined"==typeof t?!1:(t.parent_id=e.activeTeam.ministry_id,void o.createMinistry(t,function(t){s.success(u.getString("Sub ministry was created successfully"));var n={ministry_id:t.id,name:t.name,min_code:t.min_code,parent_id:t.parent_id};angular.isDefined(e.activeTeam.sub_ministries)?e.activeTeam.sub_ministries.push(n):e.activeTeam.sub_ministries=[n]},function(){s.error(u.getString("Unable to add sub ministry"))}))}),m()},e.memberDraggableOptions={containment:"#team-member-pane",refreshPositions:!0,cursorAt:{bottom:0},helper:function(e){var t=$(e.target).closest("tr"),n=t.find("td:first").text(),r=t.find("td:nth-child(2)").text(),i=t.find("td:nth-child(3)").text(),a=""===i?"none":"hide";return $('<tr class="drag-member"><td><i class="glyphicon glyphicon-user"></i></td><td>'+n+"</td><td>"+r+'</td><td style="display:'+a+'">'+i+"</td></tr>")}},e.teamDraggableOptions={refreshPositions:!0,helper:function(e){var t=$(e.target).closest("span").text();return $('<span class="drag-team"><i class="glyphicon glyphicon-certificate"></i> '+t+"</span>")}},e.teamOnStart=function(t,n,r){e.draggedType="team",e.draggedTeam=r},e.memberOnStart=function(t,n,r){e.draggedType="member",e.draggedMember=r},e.teamOnDrop=function(t,n,i){if($(t.target).removeClass("drag-on-over"),"team"===e.draggedType){var a=angular.copy(e.draggedTeam),c={ministry_id:e.draggedTeam.ministry_id,min_code:e.draggedTeam.min_code,parent_id:i.ministry_id};o.updateMinistry(c,function(t){s.success(u.getString("Ministry was moved successfully")),i.hasOwnProperty("sub_ministries")?i.sub_ministries.push(a):(i.sub_ministries=[],i.sub_ministries.push(a)),e.draggedTeam.ministry_id===c.ministry_id&&(e.draggedTeam.hide_after_drop=!0)},function(){s.error(u.getString("Unable to move ministry"))})}else{if("member"!==e.draggedType)return!1;var l={assignment_id:e.draggedMember.assignment_id,key_guid:e.draggedMember.key_guid,username:e.draggedMember.key_username,team_role:e.draggedMember.team_role,ministry_id:i.ministry_id};r.addTeamMember(l,function(){e.draggedMember.team_role="former_member",s.success(u.getString("Member was moved to ministry successfully")),r.saveAssignment({assignment_id:l.assignment_id},{team_role:"former_member"},function(){e.draggedMember.team_role="former_member"},function(){e.draggedMember.team_role=l.team_role})},function(){s.error(u.getString("Unable to move member"))})}},e.teamBeforeDrop=function(t,n,r){return $(t.target).removeClass("drag-on-over"),"team"==e.draggedType?r.ministry_id===e.draggedTeam.parent_id?(s.error(u.getString("Drop canceled, can't be dropped on parent team")),{then:function(){return!1}}):r.parent_id===e.draggedTeam.ministry_id?(s.error(u.getString("Drop canceled, can't be dropped on child team")),{then:function(){return!1}}):e.draggedTeam.hasOwnProperty("sub_ministries")&&f(e.draggedTeam,r)?(s.error(u.getString("Drop canceled, can't be dropped on child team")),{then:function(){return!1}}):g(r):"member"==e.draggedType?e.activeTeam.ministry_id===r.ministry_id?(s.error(u.getString("Drop canceled, can't be dropped on selected team")),{then:function(){return!1}}):d(r):!1},e.teamOnOver=function(e,t,n){$(e.target).addClass("drag-on-over"),n===!0&&angular.element(e.target).find("i").trigger("click")},e.teamOnOut=function(e){$(e.target).removeClass("drag-on-over")},e.isMemberDraggable=function(e){return"undefined"==typeof e.assignment_id||""===e.assignment_id.trim()?!1:"undefined"==typeof e.key_guid?!1:"undefined"==typeof e.key_username?!1:""==e.key_guid?!1:""==e.key_username?!1:!_.contains(["inherited_admin","inherited_leader","blocked","former_member"],e.team_role)},e.getCurrentUserRole=function(e){return p(e)}}e.$inject=["$scope","$filter","$modal","Assignments","MeasurementTypes","GoogleAnalytics","Ministries","growl","UserPreference","gettextCatalog","gettext"],angular.module("gma.controllers.admin").controller("AdminCtrl",e)}(),function(){"use strict";function e(e,t){e.current.isLoaded=!0,e.loginUrl=t.api.login}e.$inject=["$scope","Settings"],angular.module("gma.controllers.error").controller("ErrorCtrl",e)}(),function(e){"use strict";function t(t,n,r,i,a,o,s,c,u,l,m,d,g,p){function f(){t.map=new google.maps.Map(document.getElementById("map_canvas"),S),t.map.setOptions({draggableCursor:""}),google.maps.event.addListener(t.map,"idle",function(){t.current.isLoaded=!0;var e=t.map.getBounds(),n=e.getNorthEast(),r=e.getSouthWest();n.lat()==r.lat()&&n.lng()==r.lng()?google.maps.event.trigger(t.map,"resize"):t.loadChurches()}),t.map.markers=[],t.church={name:""},t.churchWindow=new google.maps.InfoWindow,t.churchWindowContent=n('<div id="church_window_content" ng-include="\'partials/map/edit-church.html\'"></div>')(t),t.churchWindow.setOptions({maxWidth:300}),t.trainingWindow=new google.maps.InfoWindow,t.trainingWindowContent=n('<div id="training_window_content" ng-include="\'partials/map/edit-training.html\'"></div>')(t),t.trainingWindow.setOptions({maxWidth:400}),t.targetCityWindow=new google.maps.InfoWindow,t.targetCityWindowContent=n('<div id="traget_city_window_content" ng-include="\'partials/map/edit-target-city.html\'"></div>')(t),t.targetCityWindow.setOptions({maxWidth:300}),t.newChurchWindow=new google.maps.InfoWindow,google.maps.event.addListener(t.newChurchWindow,"closeclick",function(){t.cancelAddNewIcon()}),t.newChurchWindowContent=n('<div id="new_church_window_content" ng-include="\'partials/map/new-church.html\'"></div>')(t),t.newChurchWindow.setOptions({maxWidth:300}),t.newTrainingWindow=new google.maps.InfoWindow,google.maps.event.addListener(t.newTrainingWindow,"closeclick",function(){t.cancelAddNewIcon()}),t.newTrainingContent=n('<div id="new_training_window_content" ng-include="\'partials/map/new-training.html\'"></div>')(t),t.newTrainingWindow.setOptions({maxWidth:300}),t.newTargetCityWindow=new google.maps.InfoWindow,google.maps.event.addListener(t.newTargetCityWindow,"closeclick",function(){t.cancelAddNewIcon()}),t.newTargetCityContent=n('<div id="new_target_city_window_content" ng-include="\'partials/map/new-target-city.html\'"></div>')(t),t.newTargetCityWindow.setOptions({maxWidth:300}),t.map.church_lines=[],t.map.icons={church:new google.maps.MarkerImage(o.versionUrl("img/icon/church.png"),new google.maps.Size(60,60),new google.maps.Point(0,0),new google.maps.Point(30,58)),cluster:new google.maps.MarkerImage(o.versionUrl("img/icon/cluster.png"),new google.maps.Size(60,60),new google.maps.Point(0,0),new google.maps.Point(30,31)),multiplying:new google.maps.MarkerImage(o.versionUrl("img/icon/multiplying.png"),new google.maps.Size(60,60),new google.maps.Point(0,0),new google.maps.Point(30,53)),group:new google.maps.MarkerImage(o.versionUrl("img/icon/group.png"),new google.maps.Size(60,60),new google.maps.Point(0,0),new google.maps.Point(30,55)),targetpoint:new google.maps.MarkerImage(o.versionUrl("img/icon/target.png"),new google.maps.Size(60,60),new google.maps.Point(0,0),new google.maps.Point(32,56)),training:new google.maps.MarkerImage(o.versionUrl("img/icon/training.png"),new google.maps.Size(60,60),new google.maps.Point(0,0),new google.maps.Point(30,43)),targetCity:new google.maps.MarkerImage(o.versionUrl("img/icon/target-city.png"),new google.maps.Size(60,60),new google.maps.Point(0,0),new google.maps.Point(30,43))},t.map.side=document.getElementById("side"),t.map.side.index=-1,t.map.side.style.display="block",t.map.search=document.getElementById("map_controls"),t.map.search.index=3,t.map.search.style.display="block",t.map.controls[google.maps.ControlPosition.TOP_RIGHT].push(t.map.side),t.map.controls[google.maps.ControlPosition.TOP_LEFT].push(t.map.search),t.autocomplete=new google.maps.places.Autocomplete(document.getElementById("searchBox")),t.autocomplete.bindTo("bounds",t.map),google.maps.event.addListener(t.autocomplete,"place_changed",function(){var e=t.autocomplete.getPlace();e.geometry&&(e.geometry.viewport?t.map.fitBounds(e.geometry.viewport):(t.map.setCenter(e.geometry.location),t.map.setZoom(15)),t.cancelAddNewIcon())}),t.current.assignment&&y(),t.$watch("current.assignment",function(e,n){if("undefined"!=typeof e){var r,i,a;if(e&&e.hasOwnProperty("location")&&(r=e.location.latitude,i=e.location.longitude),e&&e.hasOwnProperty("location_zoom")&&(a=e.location_zoom),"object"==typeof t.current.user_preferences&&"object"==typeof t.current.user_preferences.default_map_views){
var o=_.find(t.current.user_preferences.default_map_views,function(e){return e.ministry_id===t.current.assignment.ministry_id});"undefined"!=typeof o&&(r=o.location.latitude,i=o.location.longitude,a=o.location_zoom)}"undefined"!=typeof r&&"undefined"!=typeof i&&"undefined"!=typeof a&&(t.map.setCenter(new google.maps.LatLng(r,i)),t.map.setZoom(parseInt(a)))}},!0)}function h(){return"undefined"!=typeof t.ISOCountries&&0!==t.ISOCountries.length?t.ISOCountries:void m.getCountries().success(function(e){t.ISOCountries=e,t.ISOCountries=_.sortBy(t.ISOCountries,"name")}).error(function(){l.error(p.getString("Unable to load countries list"))})}function y(){if("undefined"!=typeof t.map){var e=[];angular.forEach(t.map.markers,function(n){"t"==n.id[0]&&0==t.trainings.filter(function(e){return e.id==n.id}).length?e.push(n):"t"!=n.id[0]||t.iconFilters.training||e.push(n)}),angular.forEach(e,function(e){e.setMap(null);var n=t.map.markers.splice(t.map.markers.indexOf(e),1);n=null}),t.iconFilters.training&&angular.forEach(t.trainings,function(e){if(0==t.map.markers.filter(function(t){return t.id==="t"+e.id}).length&&e.longitude){var n=new MarkerWithLabel({position:new google.maps.LatLng(e.latitude,e.longitude),map:t.map,id:"t"+e.id,title:e.name+" ("+e.type+")",icon:t.map.icons.training,labelContent:"",labelAnchor:new google.maps.Point(30,0),labelClass:"labelMarker",labelInBackground:!1,draggable:!1});n.setAnimation(google.maps.Animation.DROP),t.trainingWindow.getContent()||t.trainingWindow.setContent(t.trainingWindowContent[0].nextSibling),google.maps.event.addListener(n,"click",function(e,n){return function(){t.edit_training=e,t.edit_training.editable=!1;var r=w(t.current.assignments,t.edit_training),i=_.find(r,function(e){return e===t.current.assignment.ministry_id});"undefined"!=typeof i&&(t.edit_training.ministry_id===i?(t.edit_training.created_by===t.current.user.person_id||b()===!0)&&(t.edit_training.editable=!0):b()===!0&&(t.edit_training.editable=!0)),t.$apply(),t.trainingWindow.close(),t.trainingWindow.setOptions({maxWidth:400}),t.trainingWindow.open(t.map,n)}}(e,n,t)),google.maps.event.addListener(n,"dragend",function(){e.latitude=n.getPosition().lat(),e.longitude=n.getPosition().lng(),r.updateTraining(t.current.sessionToken,e).then(t.onSaveChurch),n.setAnimation(null),n.setDraggable(!1)}),t.map.markers.push(n)}})}}function v(){if("undefined"!=typeof t.map){var e=[];angular.forEach(t.map.markers,function(n){"c"==n.id[0]&&0==t.targetCities.filter(function(e){return n.id==="c"+e.target_city_id}).length?e.push(n):"c"!=n.id[0]||t.iconFilters.targetCity||e.push(n)}),angular.forEach(e,function(e){e.setMap(null);var n=t.map.markers.splice(t.map.markers.indexOf(e),1);n=null}),t.isTargetCitiesVisible&&t.iconFilters.targetCity&&angular.forEach(t.targetCities,function(e){if(0==t.map.markers.filter(function(t){return t.id==="c"+e.target_city_id}).length&&e.longitude){var n=new MarkerWithLabel({position:new google.maps.LatLng(e.latitude,e.longitude),map:t.map,id:"c"+e.target_city_id,title:e.name,icon:t.map.icons.targetCity,labelContent:"",labelAnchor:new google.maps.Point(30,0),labelClass:"labelMarker",labelInBackground:!1,draggable:!1});n.setAnimation(google.maps.Animation.DROP),t.targetCityWindow.getContent()||t.targetCityWindow.setContent(t.targetCityWindowContent[0].nextSibling),google.maps.event.addListener(n,"click",function(e,n){return function(){t.edit_targetCity=e,t.$apply(),t.targetCityWindow.close(),t.targetCityWindow.setOptions({maxWidth:300}),h(),t.targetCityWindow.open(t.map,n)}}(e,n,t)),google.maps.event.addListener(n,"dragend",function(){e.latitude=n.getPosition().lat(),e.longitude=n.getPosition().lng(),d.updateTargetCity(e).success(function(e){l.success(p.getString("Target city position was updated"))}).error(function(e){l.error(p.getString("Unable to update target city"))}),n.setAnimation(null),n.setDraggable(!1)}),t.map.markers.push(n)}})}}function w(e,t){function n(e,t){angular.forEach(t,function(r){r.ministry_id===e&&(i.push(r.parent_id),n(r.parent_id,t))})}var r=c.getFlatMinistry(e),i=[];return i.push(t.ministry_id),n(t.ministry_id,r),i=_.uniq(i)}function b(){return t.current.hasRole(["admin","inherited_admin","leader","inherited_leader"])}function C(e,t){e.yes=function(){t.close(!0)},e.no=function(){t.dismiss("cancel")}}function M(){return"undefined"==typeof t.current.assignment?!1:t.current.hasRole(["admin","inherited_admin","leader","inherited_leader","member"])?"undefined"==typeof t.current.mcc?!1:"llm"!==t.current.mcc||"undefined"==typeof t.current.assignment.area_code||"undefined"==typeof t.current.assignment.ministry_scope||"Area"!=t.current.assignment.ministry_scope&&"National"!=t.current.assignment.ministry_scope?!1:!0:!1}function T(){window.setTimeout(function(){window.parent.scrollTo(0,0)},10)}t.current.isLoaded=!1,t.versionUrl=o.versionUrl,t.area_codes=_.sortBy(o.area_codes,"name"),t.new_church={},t.new_training={},t.new_targetCity={},t.edit_church={},t.SetParentMode=!1,t.church_lines=[],t.churches=[],t.trainings=[],t.targetCities=[],t.training_types=[{value:"MC2",text:"MC2"},{value:"T4T",text:"T4T"},{value:"CPMI",text:"CPMI"},{value:"",text:"Other"}],t.iconFilters={training:!0,targetCity:!0,target_point:!0,group:!0,church:!0,mult_church:!0,parent_lines:!0,jesus_film:!0},t.map_scope_filter="min_only",t.targetCitySubStages=[{val:"0",name:"0 - Nothing yet",stage:0},{val:"0a",name:"0a - Pioneering",stage:0},{val:"1a",name:"1a - Startup (1-5 Groups)",stage:1},{val:"1b",name:"1b - Solidification (5-10 groups)",stage:1},{val:"2",name:"2 - Growth (> 10 groups)",stage:2},{val:"3",name:"3 - Partnering (>30 groups)",stage:3}];var S={zoom:3,center:new google.maps.LatLng(0,0),panControl:!0,zoomControl:!0,zoomControlOptions:{position:google.maps.ControlPosition.LEFT_CENTER},mapTypeControl:!0,mapTypeControlOptions:{style:google.maps.MapTypeControlStyle.DROPDOWN_MENU,position:google.maps.ControlPosition.TOP_RIGHT},streetViewControl:!1,overviewMapControl:!1};t.supportsGeoLocation="undefined"!=typeof navigator.geolocation,setTimeout(f,0);var $=_.throttle(function(){s.screen("Map",function(){var e={};return e[s.DIM.guid]=t.current.user.key_guid,angular.isDefined(t.current.assignment.ministry_id)&&(e[s.DIM.ministry_id]=t.current.assignment.ministry_id),angular.isDefined(t.current.mcc)&&(e[s.DIM.mcc]=t.current.mcc),angular.isDefined(t.current.period)&&(e[s.DIM.period]=t.current.period.format("YYYY-MM")),e}())},1e3,{leading:!1});t.$watch("current.assignment.ministry_id",function(e){"undefined"==typeof e?t.trainings=[]:($(),t.loadTrainings(),t.isTargetCitiesVisible=M(),t.loadTargetCities())}),t.$watch("map_scope_filter",function(e){void 0!==e&&(t.loadChurches(),t.loadTrainings())}),t.$watch("current.mcc",function(e){"undefined"==typeof e?t.trainings=[]:($(),t.loadChurches(),t.loadTrainings(),t.isTargetCitiesVisible=M(),t.loadTargetCities())}),t.loadTargetCities=_.debounce(function(){if(t.isTargetCitiesVisible&&"undefined"!=typeof t.current.assignment&&"llm"===t.current.mcc&&"undefined"!==t.current.assignment.area_code){var e=t.map.getBounds(),n=e.getNorthEast(),r=e.getSouthWest(),i={lat_min:r.lat(),lat_max:n.lat(),long_min:r.lng(),long_max:n.lng(),period:t.current.period.format("YYYY-MM"),area_code:t.current.assignment.area_code};d.searchTargetCities(i).success(function(e){t.targetCities=e}).error(function(e){l.error(p.getString("Unable to load target cities"))})}else t.targetCities=[]},500),t.loadTrainings=_.debounce(function(){var e=!1,n=!1;("everything"===t.map_scope_filter||"tree"===t.map_scope_filter)&&(e=!0),"undefined"!=typeof t.current.assignment&&"undefined"!==t.current.mcc?r.getTrainings(t.current.sessionToken,t.current.assignment.ministry_id,t.current.mcc,n,e).then(function(e){t.trainings=e},function(){l.error(p.getString("Unable to load trainings"))}):t.trainings=[]},500),t.loadChurches=_.debounce(function(){if("undefined"!=typeof t.current.assignment){var e=t.map.getBounds(),n=e.getNorthEast(),r=e.getSouthWest(),a={ministry_id:t.current.assignment.ministry_id,lat_min:r.lat(),lat_max:n.lat(),long_min:r.lng(),long_max:n.lng(),period:t.current.period.format("YYYY-MM")};t.iconFilters.target_point||(a.hide_target_point="true"),t.iconFilters.group||(a.hide_group="true"),t.iconFilters.church||(a.hide_church="true"),t.iconFilters.mult_church||(a.hide_mult_church="true"),"everything"===t.map_scope_filter?a.show_all="true":"tree"===t.map_scope_filter&&(a.show_tree="true"),t.map.getZoom()>=14&&(a.should_cluster="false"),i.getChurches(a).$promise.then(t.onGetChurches)}},500),t.$watch("iconFilters.parent_lines",function(){"undefined"!=typeof t.map&&angular.forEach(t.map.church_lines,function(e){e.setVisible(t.iconFilters.parent_lines)})}),t.$watch("iconFilters.jesus_film",function(){t.iconFilters.jesus_film?e(".jf_label").show():e(".jf_label").hide()}),t.onAddChurch=function(e){s.event("church","create",function(){var n={};return n[s.DIM.guid]=t.current.user.key_guid,angular.isDefined(t.current.assignment.ministry_id)&&(n[s.DIM.ministry_id]=t.current.assignment.ministry_id),angular.isDefined(t.current.mcc)&&(n[s.DIM.mcc]=t.current.mcc),angular.isDefined(t.current.period)&&(n[s.DIM.period]=t.current.period.format("YYYY-MM")),n[s.DIM.church_id]=e.id,n}()),t.loadChurches()},t.addChurch=function(){t.newChurchWindow.close(),angular.forEach(t.map.markers,function(e){if(-1==e.id){var n=angular.copy(t.new_church);n.ministry_id=t.current.assignment.ministry_id,n.latitude=e.getPosition().lat(),n.longitude=e.getPosition().lng(),n.jf_contrib=1==t.new_church.jf_contrib,i.addChurch(n).$promise.then(function(e){l.success(p.getString("Church was created")),t.onAddChurch(e)},function(e){l.error(p.getString("Unable to create church"))}),e.setMap(null);var r=t.map.markers.splice(t.map.markers.indexOf(e),1);r=null}})},t.addTraining=function(){angular.forEach(t.map.markers,function(e){if(-2==e.id){t.new_training.ministry_id=t.current.assignment.ministry_id,t.new_training.latitude=e.getPosition().lat(),t.new_training.longitude=e.getPosition().lng(),t.new_training.mcc=t.current.mcc,r.addTraining(t.current.sessionToken,t.new_training).then(function(){l.success(p.getString("Training was created")),t.loadTrainings()}),e.setMap(null);var n=t.map.markers.splice(t.map.markers.indexOf(e),1);n=null}})},t.addTargetCity=function(e){angular.forEach(t.map.markers,function(n){if(-3==n.id){e.latitude=n.getPosition().lat(),e.longitude=n.getPosition().lng(),e.period=t.current.period.format("YYYY-MM"),"GLBL"!==t.current.assignment.area_code&&(e.area_code=t.current.assignment.area_code),d.createTargetCity(e).success(function(){l.success(p.getString("Target city was created successfully")),e={},t.loadTargetCities()}).error(function(e){400===e.status?l.error(p.getString("Bad Request: Unable to create target city")):l.error(p.getString("Error: Unable to create target city"))}),n.setMap(null);var r=t.map.markers.splice(t.map.markers.indexOf(n),1);r=null}})},t.cancelAddNewIcon=function(){angular.forEach(t.map.markers,function(e){if(e.id<0){e.setMap(null);var n=t.map.markers.splice(t.map.markers.indexOf(e),1);n=null}}),t.new_church={},t.new_training={},t.new_targetCity={}},t.onAddTraining=function(){if(0==t.map.markers.filter(function(e){return e.id<0}).length){t.new_training={};var e=new MarkerWithLabel({position:t.map.getCenter(),map:t.map,title:"new_training",id:-2,cluster_count:1,zIndex:9999,icon:t.map.icons.training,labelContent:p.getString("Drag to Move"),labelAnchor:new google.maps.Point(75,-5),labelClass:"labelMoveMarker",labelInBackground:!1,draggable:!0});e.setAnimation(google.maps.Animation.BOUNCE),t.newTrainingWindow.getContent()||t.newTrainingWindow.setContent(t.newTrainingContent[0].nextSibling),t.newTrainingWindow.open(t.map,e),t.map.markers.push(e)}},t.onAddTargetCity=function(){if(0==t.map.markers.filter(function(e){return e.id<0}).length){t.new_targetCity={};var e=new MarkerWithLabel({position:t.map.getCenter(),map:t.map,title:"new_targetCity",id:-3,cluster_count:1,zIndex:9999,icon:t.map.icons.targetCity,labelContent:p.getString("Drag to Move"),labelAnchor:new google.maps.Point(75,-5),labelClass:"labelMoveMarker",labelInBackground:!1,draggable:!0});e.setAnimation(google.maps.Animation.BOUNCE),t.newTargetCityWindow.getContent()||t.newTargetCityWindow.setContent(t.newTargetCityContent[0].nextSibling),t.newTargetCityWindow.open(t.map,e),h(),t.map.markers.push(e)}},t.onSaveChurch=function(e){t.loadChurches()},t.onAddIcon=function(){if(0==t.map.markers.filter(function(e){return e.id<0}).length){t.new_church={security:2};var e=new MarkerWithLabel({position:t.map.getCenter(),map:t.map,title:"new church",id:-1,cluster_count:1,zIndex:9999,icon:t.map.icons.targetpoint,labelContent:p.getString("Drag to Move"),labelAnchor:new google.maps.Point(75,-20),labelClass:"labelMoveMarker",labelInBackground:!1,draggable:!0});e.setAnimation(google.maps.Animation.BOUNCE),t.newChurchWindow.getContent()||t.newChurchWindow.setContent(t.newChurchWindowContent[0].nextSibling),t.newChurchWindow.open(t.map,e),t.map.markers.push(e)}},t.SetParent=function(){t.SetParentMode=!0,t.churchWindow.close(),t.new_parentLine=new google.maps.Polyline({path:[new google.maps.LatLng(t.edit_church.latitude,t.edit_church.longitude),new google.maps.LatLng(t.edit_church.latitude,t.edit_church.longitude)],geodesic:!0,strokeColor:"#777",strokeOpacity:1,strokeWeight:2,icons:[{icon:{path:google.maps.SymbolPath.FORWARD_OPEN_ARROW,strokeWeight:1.5},offset:"12px",repeat:"25px"}]}),t.move_event=google.maps.event.addListener(t.map,"mousemove",function(e){t.new_parentLine.setPath([e.latLng,new google.maps.LatLng(t.edit_church.latitude,t.edit_church.longitude)])}),t.new_parentLine.setMap(t.map)},document.onkeydown=function(e){e=e||window.event,t.SetParentMode&&27==e.keyCode&&(google.maps.event.removeListener(t.move_event),t.SetParentMode=!1,t.new_parentLine.setMap(null))},t.$on("$destroy",function(){document.onkeydown=null}),t.RemoveParent=function(){t.churchWindow.close(),t.edit_church.parent_id=null,t.edit_church.parents=[],i.saveChurch({id:t.edit_church.id,parent_id:-1}).$promise.then(t.onSaveChurch)},t.makeMovableIcon={MoveChurch:function(){angular.forEach(t.map.markers,function(e){e.id===t.edit_church.id&&(e.setAnimation(google.maps.Animation.BOUNCE),e.setDraggable(!0),t.churchWindow.close())})},MoveTraining:function(){var e=t.edit_training.id;angular.forEach(t.map.markers,function(n){n.id==="t"+e&&(n.setAnimation(google.maps.Animation.BOUNCE),n.setDraggable(!0),t.trainingWindow.close())})},MoveTargetCity:function(){var e=t.edit_targetCity.target_city_id;angular.forEach(t.map.markers,function(n){n.id==="c"+e&&(n.setAnimation(google.maps.Animation.BOUNCE),n.setDraggable(!0),t.targetCityWindow.close())})}},t.updateChurch=function(){t.churchWindow.close();var e=angular.copy(t.edit_church);e.jf_contrib=1==t.edit_church.jf_contrib,delete e.editable,i.saveChurch(e).$promise.then(function(e){l.success(p.getString("Church was updated successfully")),t.onSaveChurch(e)},function(){l.error(p.getString("Unable to update church"))})},t.DeleteChurch=function(){u.open({templateUrl:"partials/map/_confirmation-dialog.html",controller:C}).result.then(function(e){t.edit_church.end_date=moment().subtract(1,"months").endOf("month").format("YYYY-MM-DD"),i.saveChurch(t.edit_church).$promise.then(function(e){l.success(p.getString("Church was deleted successfully")),t.onSaveChurch(e)},function(){l.error(p.getString("Unable to delete church"))})}),T()},t.updateTraining=function(){r.updateTraining(t.current.sessionToken,t.edit_training).then(function(e){l.success(p.getString("Training was updated")),t.onSaveChurch(e)},function(){l.error(p.getString("Unable to update training"))}),t.trainingWindow.close()},t.updateTrainingCompletion=function(e){r.updateTrainingCompletion(t.current.sessionToken,e).then(function(){l.success(p.getString("Training was updated"))})},t.updateTargetCity=function(e){"GLBL"!==t.current.assignment.area_code&&(e.area_code=t.current.assignment.area_code),d.updateTargetCity(e).success(function(e){l.success(p.getString("Target city was updated"))}).error(function(e){l.error(p.getString("Unable to update target city"))}),t.targetCityWindow.close()},t.$watch("trainings",function(){t.map&&y()}),t.$watch("iconFilters.training",y,!0),t.$watch("iconFilters.targetCity",function(){v()},!0),t.$watch("targetCities",function(){t.map&&v()}),t.onGetChurches=function(e){"gcm"===t.current.mcc?t.churches=e:(e=[],t.churches=[]),angular.forEach(t.map.church_lines,function(e){e.setMap(null)});var n=[];angular.forEach(t.map.markers,function(t){t.id>0&&(0==e.filter(function(e){return e.id==t.id&&1==e.cluster_count}).length||t.cluster_count>1)&&n.push(t)}),angular.forEach(n,function(e){angular.element("div#map_canvas div#jf_icon_"+e.id+".jf_label").remove(),e.setMap(null);var n=t.map.markers.splice(t.map.markers.indexOf(e),1);n=null}),angular.forEach(t.churches,function(e){if(0==t.map.markers.filter(function(t){return t.id==e.id}).length){var n={};if(1==e.cluster_count){var r={};r=5==e.development?t.map.icons.multiplying:4==e.development?t.map.icons.church:3==e.development?t.map.icons.church:2==e.development?t.map.icons.group:1==e.development?t.map.icons.targetpoint:t.map.icons.church,n=new MarkerWithLabel({position:new google.maps.LatLng(e.latitude,e.longitude),map:t.map,title:e.name,id:e.id,cluster_count:e.cluster_count,icon:r,labelContent:e.name,labelAnchor:new google.maps.Point(30,0),labelClass:"labelMarker",labelInBackground:!1,draggable:!1}),n.setAnimation(google.maps.Animation.DROP),e.jf_contrib>=1&&new t.jesusFilmSign(new google.maps.LatLng(e.latitude,e.longitude),e.jf_contrib,e.development,e.id)}else n=new MarkerWithLabel({position:new google.maps.LatLng(e.latitude,e.longitude),map:t.map,title:"Click to zoom",id:e.id,cluster_count:e.cluster_count,icon:t.map.icons.cluster,labelContent:e.cluster_count.toString(),labelAnchor:new google.maps.Point(30,15),labelClass:"clusterMarker",labelInBackground:!1}),e.jf_contrib>1&&new t.jesusFilmSign(new google.maps.LatLng(e.latitude,e.longitude),e.jf_contrib,"cluster",e.id);t.churchWindow.getContent()||t.churchWindow.setContent(t.churchWindowContent[0].nextSibling),google.maps.event.addListener(n,"click",function(e,n){return function(){if(t.SetParentMode)if(1!=e.cluster_count||e.id===t.edit_church.id||_.contains(e.parents,t.edit_church.id))google.maps.event.removeListener(t.move_event),t.SetParentMode=!1,t.new_parentLine.setMap(null);else{google.maps.event.removeListener(t.move_event),t.SetParentMode=!1,t.new_parentLine.setPath([new google.maps.LatLng(e.latitude,e.longitude),new google.maps.LatLng(t.edit_church.latitude,t.edit_church.longitude)]);var r={};r.id=t.edit_church.id,r.parent_id=e.id,t.edit_church.parent_id=e.id,t.edit_church.parents=[e.id],i.saveChurch(r).$promise.then(t.onSaveChurch)}else if(1==e.cluster_count){t.edit_church=e,t.edit_church.jf_contrib=t.edit_church.jf_contrib>=1?1:0,t.edit_church.editable=!1;var a=w(t.current.assignments,t.edit_church),o=_.find(a,function(e){return e===t.current.assignment.ministry_id});"undefined"!=typeof o&&(t.edit_church.ministry_id===o?(t.edit_church.created_by===t.current.user.person_id||b()===!0)&&(t.edit_church.editable=!0):b()===!0&&(t.edit_church.editable=!0)),t.$apply(),t.churchWindow.close(),t.churchWindow.setOptions({maxWidth:300}),t.churchWindow.open(t.map,n)}else t.map.setCenter(n.position),t.map.setZoom(t.map.getZoom()+2)}}(e,n,t)),google.maps.event.addListener(n,"dragend",function(e,n){return function(){if(1==e.cluster_count){var r={};r.id=e.id,r.latitude=n.getPosition().lat(),r.longitude=n.getPosition().lng(),e.latitude=r.latitude,e.longitude=r.longitude,i.saveChurch(r).$promise.then(t.onSaveChurch),n.setAnimation(null),n.setDraggable(!1)}}}(e,n)),t.map.markers.push(n)}angular.forEach(e.parents,function(n){var r=t.churches.filter(function(e){return e.id==n});if(r.length>0){var i=new google.maps.Polyline({path:[new google.maps.LatLng(r[0].latitude,r[0].longitude),new google.maps.LatLng(e.latitude,e.longitude)],geodesic:!0,strokeColor:"#777",strokeOpacity:1,strokeWeight:2,icons:[{icon:{path:google.maps.SymbolPath.FORWARD_OPEN_ARROW,strokeWeight:1.5},offset:"12px",repeat:"25px"}]});i.setMap(t.map),t.map.church_lines.push(i)}})})},t.jesusFilmSign=function(e,n,r,i){this.div_=null,this.setMap(t.map),1==n&&(n="JF"),this.onAdd=function(){var e=document.createElement("div");e.className="jf_label",e.id="jf_icon_"+i,e.innerHTML=n,this.div_=e;var t=this.getPanes();t.overlayMouseTarget.appendChild(e)},this.draw=function(){var t,n,i=this.div_,a=this.getProjection(),o=a.fromLatLngToDivPixel(e);"cluster"==r?(t=-20,n=8):r>=0&&1>=r?(t=-23,n=-12):2==r?(t=-22,n=-13):r>=3?(t=-20,n=-13):(t=0,n=0),i.style.left=o.x+t+"px",i.style.top=o.y+n+"px"},this.onRemove=function(){this.div_.parentNode.removeChild(t.div_),this.div_=null}},t.jesusFilmSign.prototype=new google.maps.OverlayView,t.addTrainingStage=function(e){if(void 0===e.insert||void 0===e.insert.date||void 0===e.insert.number_completed)return!1;var n={phase:e.current_stage,date:e.insert.date,number_completed:e.insert.number_completed,training_id:e.id};r.addTrainingCompletion(t.current.sessionToken,n).then(t.onAddTrainingCompletion),e.insert.date="",e.insert.number_completed=0},t.onAddTrainingCompletion=function(e){e.editMode=!1,l.success(p.getString("Training was saved successfully")),angular.forEach(t.trainings,function(t){var n=t.hasOwnProperty("Id")?t.Id:t.id;n==e.training_id&&(t.gcm_training_completions.push(e),t.current_stage=e.phase+1)})},t.DeleteTraining=function(){u.open({templateUrl:"partials/map/_confirmation-dialog.html",controller:C}).result.then(function(e){r.deleteTraining(t.current.sessionToken,t.edit_training).then(function(e){l.success(p.getString("Training was deleted successfully")),t.trainingWindow.close(),t.loadTrainings()},function(e){l.error(p.getString("Unable to delete training"))})}),T()},t.DeleteTargetCity=function(e){u.open({templateUrl:"partials/map/_confirmation-dialog.html",controller:C}).result.then(function(n){d.deleteTargetCity(e.target_city_id).success(function(e){l.success(p.getString("Target city was deleted successfully")),t.targetCityWindow.close(),t.loadTargetCities()}).error(function(e){l.error(p.getString("Unable to delete target city"))})}),T()},t.deleteTrainingComplete=function(e,n){u.open({templateUrl:"partials/map/_confirmation-dialog.html",controller:C}).result.then(function(i){r.deleteTrainingCompletion(t.current.sessionToken,e).then(function(e){l.success(p.getString("Training stage was deleted successfully")),t.edit_training.gcm_training_completions.splice(n,1)})}),T()},t.setMyDefaultMapView=function(){var e=t.map.getCenter(),n={default_map_views:[{ministry_id:t.current.assignment.ministry_id,location:{latitude:e.lat(),longitude:e.lng()},location_zoom:t.map.getZoom()}]};c.savePreference(n).success(function(e){l.success(p.getString("Your default map view has been set")),t.current.user_preferences=e},function(){l.error(p.getString("Unable to save default map view"))})},t.setMinistryDefaultView=function(){var e=t.map.getCenter();a.updateMinistry({ministry_id:t.current.assignment.ministry_id,min_code:t.current.assignment.min_code.trim(),location:{latitude:e.lat(),longitude:e.lng()},location_zoom:t.map.getZoom()},function(e){l.success(p.getString("Default ministry map view has been set"))},function(){l.error(p.getString("Unable to save default map view"))})},t.myLocation=function(){navigator.geolocation?navigator.geolocation.getCurrentPosition(function(e){var n=new google.maps.LatLng(e.coords.latitude,e.coords.longitude);t.map.setCenter(n),t.map.setZoom(15)},function(){l.error(p.getString("Failed to get your current location"))}):l.error(p.getString("Your browser does not support GeoLocation"))},C.$inject=["$scope","$modalInstance"],t.addStoryToIcon=function(e,n){u.open({templateUrl:"partials/stories/new-story-dialog.html",size:"lg",controller:["$scope","$modalInstance","modalData",function(e,t,n){e.imageFile={},e.storiesConfig=n.storiesConfig,e.iconName=n.iconName,e.close=function(){t.dismiss("cancel")},e.saveStory=function(n){t.close({story:n,imageFile:e.imageFile})}}],resolve:{modalData:function(){return{iconName:angular.copy(e.name),storiesConfig:angular.copy(o.stories)}}}}).result.then(function(t){t.story[n+"_id"]=e.id,t.story.location={latitude:e.latitude,longitude:e.longitude},g.createStory(t.story).success(function(e){if(l.success("Story saved successfully"),"undefined"!=typeof t.imageFile.resized){var n=new FormData;n.append("image-file",t.imageFile.resized.blob,t.imageFile.file.name),g.uploadStoryImage(e.story_id,n).success(function(e){l.success(p.getString("Image file was uploaded"))}).error(function(e){400===e.status?l.error(p.getString("Upload failed, Invalid file input")):l.error(p.getString("Unable to upload image file"))})}}).error(function(){l.error(p.getString("Failed to save story"))})}),t.churchWindow.close(),t.trainingWindow.close(),T()},t.canAddStories=function(e){return"undefined"==typeof e?!1:"undefined"==typeof e.ministry_id?!1:null===e.ministry_id||""===e.ministry_id?!1:e.ministry_id!==t.current.assignment.ministry_id?!1:t.current.hasRole(["admin","inherited_admin","leader","inherited_leader","member"])}}t.$inject=["$scope","$compile","Trainings","Churches","Ministries","Settings","GoogleAnalytics","UserPreference","$modal","growl","ISOCountries","TargetCity","Stories","gettextCatalog"],angular.module("gma.controllers.map").controller("MapCtrl",t)}(jQuery),function(){"use strict";function e(e,t,n,r,i,a,o,s){e.spinner=!0,e.measurement=i,e.details=a,e.ns=o.gmaNamespace;var c=_.throttle(function(){s.screen("Measurement Details",function(){var t={};return t[s.DIM.guid]=e.current.user.key_guid,angular.isDefined(e.current.assignment.ministry_id)&&(t[s.DIM.ministry_id]=e.current.assignment.ministry_id),angular.isDefined(e.current.mcc)&&(t[s.DIM.mcc]=e.current.mcc),angular.isDefined(e.current.period)&&(t[s.DIM.period]=e.current.period.format("YYYY-MM")),angular.isDefined(e.details.perm_link_stub)&&(t[s.DIM.perm_link]=e.details.perm_link_stub),t}())},1e3,{leading:!1});e.details.$promise.then(function(){e.spinner=!1,c();var t=[["Period","Personal","Local Team","Total"]];angular.forEach(a.total,function(e,n){angular.forEach(a.local,function(r,i){i===n&&angular.forEach(a.my_measurements,function(i,a){a===n&&t.push([a,i,r,e])})})}),e.trend=google.visualization.arrayToDataTable(t)}),e.filterSource=function(e){var t={};return angular.forEach(e,function(e,n){n!=o.gmaNamespace&&"total"!=n&&(t[n]=e)}),t},e.saveDetails=function(){e.spinner=!0;var r=[];angular.forEach(["local","person"],function(t){e.editForm.hasOwnProperty(t)&&e.editForm[t].$dirty&&"undefined"!=typeof e.editForm[t]&&r.push({period:e.current.period.format("YYYY-MM"),mcc:e.current.mcc,source:o.gmaNamespace,measurement_type_id:e.details.measurement_type_ids[t],related_entity_id:"local"==t?e.current.assignment.ministry_id:e.current.assignment.id,value:e.editForm[t].$modelValue})}),r.length>0?n.saveMeasurement({},r,function(){t.close()}):t.dismiss("cancel")},e.close=function(){t.dismiss("cancel")},e.approveSelfAssigned=function(e,t){var e=e;e.state="pending",r.saveAssignment({assignment_id:e.assignment_id},{team_role:t},function(){"blocked"==t?(e.state="blocked",e.blocked=!0):(e.success=!0,e.state="member")},function(){delete e.state})}}e.$inject=["$scope","$modalInstance","Measurements","Assignments","measurement","details","Settings","GoogleAnalytics"],angular.module("gma.controllers.measurements").controller("MeasurementDetailsCtrl",e)}(),function(){"use strict";function e(e,t,n,r,i,a,o,s,c,u){function l(){return"undefined"==typeof e.current.user_preferences?d:"undefined"==typeof e.current.user_preferences.content_locales?d:"undefined"!=typeof e.current.user_preferences.content_locales[e.current.assignment.ministry_id]?e.current.user_preferences.content_locales[e.current.assignment.ministry_id]:d}function m(){e.measurementState={};var t={};"undefined"!=typeof a.default_measurement_states[e.current.mcc]&&(t=angular.copy(a.default_measurement_states[e.current.mcc])),"undefined"!=typeof e.current.user_preferences&&"undefined"!=typeof e.current.user_preferences.default_measurement_states&&"undefined"!=typeof e.current.user_preferences.default_measurement_states[e.current.mcc]?e.measurementState=e.current.user_preferences.default_measurement_states[e.current.mcc]:e.measurementState=t}var d="en-US";e.current.isLoaded=!1,e.currentLanguage=d,e.ns=a.gmaNamespace;var g=_.throttle(function(){o.screen("Measurements",function(){var t={};return t[o.DIM.guid]=e.current.user.key_guid,angular.isDefined(e.current.assignment.ministry_id)&&(t[o.DIM.ministry_id]=e.current.assignment.ministry_id),angular.isDefined(e.current.mcc)&&(t[o.DIM.mcc]=e.current.mcc),angular.isDefined(e.current.period)&&(t[o.DIM.period]=e.current.period.format("YYYY-MM")),t}())},1e3,{leading:!1});e.$watch("current.assignment.ministry_id",function(t,n){"undefined"!=typeof t&&(e.current.canAccessCurrentTab()&&"undefined"!=typeof e.current.mcc?(e.currentLanguage=l(),p(),g(),e.current.loadLanguages(),m()):e.current.redirectToHomeTab())}),e.$watch("current.mcc",function(e){p(),g(),void 0!==e&&m()}),e.$watch("current.period",function(){p(),g()});var p=_.debounce(function(){"undefined"!=typeof e.current.assignment&&"undefined"!=typeof e.current.period&&"undefined"!=typeof e.current.mcc&&e.loadMeasurements(e.currentLanguage)},100);e.loadMeasurements=function(t){(void 0===t||""===t)&&(t=d),e.current.isLoaded=!1,e.measurements=r.getMeasurements({ministry_id:e.current.assignment.ministry_id,mcc:e.current.mcc,locale:t,period:e.current.period.format("YYYY-MM")},function(){e.current.isLoaded=!0},function(){e.current.isLoaded=!0,c.error(u.getString("Unable to load measurements"))})},e.hasOther=function(){return _.where(e.measurements,{section:"other",column:"other"}).length>0},e.saveMeasurements=function(){var t=[];angular.forEach(e.measurements,function(n){angular.forEach(["person","local"],function(r){if(e.lmiForm.hasOwnProperty(n.measurement_type_ids[r])){var i=n.measurement_type_ids[r],o=e.lmiForm[i];o.$dirty&&o.$valid&&t.push({period:e.current.period.format("YYYY-MM"),mcc:e.current.mcc,source:a.gmaNamespace,measurement_type_id:i,related_entity_id:"person"===r?e.current.assignment.id:e.current.assignment.ministry_id,value:o.$modelValue})}})}),t.length>0&&r.saveMeasurement({},t,function(t){c.success(u.getString("Measurements saved successfully")),p(),e.lmiForm.$setPristine()},function(){c.error(u.getString("Unable to save measurements"))})},e.filterByLangCode=function(t){return"undefined"!=typeof e.current.assignment.content_locales&&_.contains(e.current.assignment.content_locales,t.iso_code)?t:!1},e.editMeasurementDetails=function(n){var i=t.open({templateUrl:"partials/measurements/details.html",controller:"MeasurementDetailsCtrl",keyboard:!0,backdrop:!0,resolve:{measurement:function(){return n},details:function(){return r.getMeasurement({perm_link_stub:n.perm_link_stub,ministry_id:e.current.assignment.ministry_id,mcc:e.current.mcc,period:e.current.period.format("YYYY-MM")})}}});i.result.then(function(){c.success(u.getString("Measurements updated successfully")),p()}),window.setTimeout(function(){window.parent.scrollTo(0,0)},10)};var f=s(function(){if(e.current.isLoaded&&"/measurements"===n.path()&&"undefined"!==e.current.mcc&&_.size(e.measurementState)>0){var t={default_measurement_states:{}};t.default_measurement_states[e.current.mcc]=e.measurementState,i.savePreference(t).success(function(e){},function(e){(500===e.status||400===e.status)&&s.cancel(f)})}},6e4);e.$on("$destroy",function(){s.cancel(f)}),e.toggleMeasurementState=function(e,t){e[t]=1===e[t]?0:1},e.checkMeasureState=function(t){return t.supported_staff_only===!0?"undefined"!==e.current.user_preferences.supported_staff&&"1"==e.current.user_preferences.supported_staff?t.leader_only===!0?e.current.hasRole(["admin","inherited_admin","leader","inherited_leader"]):!0:!1:t.leader_only===!0?e.current.hasRole(["admin","inherited_admin","leader","inherited_leader"]):!0;
}}e.$inject=["$scope","$modal","$location","Measurements","UserPreference","Settings","GoogleAnalytics","$interval","growl","gettextCatalog"],angular.module("gma.controllers.measurements").controller("MeasurementsCtrl",e)}(),function(){"use strict";function e(e,t,n,r,i,a,o,s){e.options={supported_staff:"0",hide_reports_tab:"0",static_locale:"en-us",content_locales:{}},e.ministries=_.sortBy(i.getFlatMinistry(e.current.assignments),"name"),e.mccs=_.sortBy(i.getMappedMCCS(e.current.assignment.mccs,r.mccLabels),"mccLabel"),e.staticLocales=angular.copy(o.static_locales),e.current.loadLanguages(),"object"==typeof e.current.user_preferences&&(e.options=angular.extend({},e.options,angular.copy(e.current.user_preferences)));var c={};"undefined"!=typeof e.current.assignment.content_locales&&(c=angular.copy(e.current.assignment.content_locales)),e.filterByLangCode=function(e){return _.contains(c,e.iso_code)?e:!1},e.savePreference=function(r){delete r.default_map_views,delete r.default_measurement_states,i.savePreference(r).success(function(n){a.success(s.getString("Your preferences were saved")),1==r.hide_reports_tab&&"/reports"==t.path()&&e.current.redirectToHomeTab(),e.current.user_preferences=n}).error(function(){a.error(s.getString("Unable to save preferences"))}),n.close(!0)},e.changeMCCS=function(t){if(""===t||null===t)return e.mccs=[],e.options.preferred_mcc="",!1;var n=_.find(e.ministries,function(e){return e.ministry_id===t});"undefined"!=typeof n?(e.mccs=_.sortBy(i.getMappedMCCS(n.mccs,r.mccLabels),"mccLabel"),0==_.size(e.mccs)&&(e.options.preferred_mcc="")):(e.options.preferred_mcc="",e.mccs=[])},e.changeMCCS(e.options.preferred_ministry),e.close=function(){n.dismiss("cancel")}}e.$inject=["$scope","$location","$modalInstance","modelData","UserPreference","growl","Settings","gettextCatalog"],angular.module("gma.controllers.preference").controller("UserPreferenceCtrl",e)}(),function(){"use strict";function e(e,t,n,r,i){function a(e){var t=[],n=0;return angular.forEach(e,function(e){0!==e&&t.push(e)}),0===t.length?0:(t.length>4&&(t.sort(function(e,t){return e-t}),t.shift(),t.pop()),angular.forEach(t,function(e){n+=e}),Math.round(n/t.length*100)/100)}e.chart=new google.visualization.LineChart(document.getElementById("reports-chart")),e.table=new google.visualization.Table(document.getElementById("reports-table"));var o=_.throttle(function(){n.screen("Reports",function(){var t={};return t[n.DIM.guid]=e.current.user.key_guid,angular.isDefined(e.current.assignment.ministry_id)&&(t[n.DIM.ministry_id]=e.current.assignment.ministry_id),angular.isDefined(e.current.mcc)&&(t[n.DIM.mcc]=e.current.mcc),angular.isDefined(e.current.period)&&(t[n.DIM.period]=e.current.period.format("YYYY-MM")),t}())},1e3,{leading:!1}),s=_.debounce(function(){"undefined"!=typeof e.current.assignment&&"undefined"!=typeof e.current.period&&"undefined"!=typeof e.current.mcc&&(delete e.dataTable,e.current.isLoaded=!1,e.measurements=t.getMeasurements({ministry_id:e.current.assignment.ministry_id,mcc:e.current.mcc,period:e.current.period.format("YYYY-MM"),historical:!0},function(){e.current.isLoaded=!0,o();var t=new google.visualization.DataTable,n=new google.visualization.DataTable,r=[];t.addColumn("string","Date"),angular.forEach(e.dates,function(n,i){r[i]=[n],angular.forEach(e.measurements,function(e){0===i&&t.addColumn("number",e.name),r[i].push(e.total[n])})}),t.addRows(r),e.dataTable=t,n.addColumn("string","Measurement"),angular.forEach(e.measurements,function(t,r){var i=[];angular.forEach(e.dates,function(e){0===r&&n.addColumn("number",e),i.push(t.total[e])}),0===r&&n.addColumn("number","Total"),n.addRow([t.name].concat(i,[a(i)]))}),e.tableDataTable=n},function(){e.current.isLoaded=!0,delete e.dataTable,i.error(r.getString("Unable to load measurements for reporting"))}))},100);e.$watch("current.assignment.ministry_id",function(t){"undefined"!=typeof t&&(e.current.canAccessCurrentTab()?s():e.current.redirectToHomeTab())}),e.$watch("current.mcc",function(){s()}),e.$watch("current.period",function(t){if("undefined"!=typeof t){s();for(var n=t.clone(),r=[],i=0;12>i;i++)r.push(n.clone().format("YYYY-MM")),n.subtract(1,"M");e.dates=r.reverse()}}),e.$watch("dataTable",function(t){"undefined"!=typeof t&&e.chart.draw(t,{chartArea:{top:20,left:50,width:"80%",height:"90%"},legend:{alignment:"start",position:"right"},orientation:"horizontal"})}),e.$watch("tableDataTable",function(t){"undefined"!=typeof t&&e.table.draw(t,{})})}e.$inject=["$scope","Measurements","GoogleAnalytics","gettextCatalog","growl"],angular.module("gma.controllers.reports").controller("ReportsCtrl",e)}(),function(){"use strict";function e(e,t,n,r,i,a,o){function s(){window.setTimeout(function(){window.parent.scrollTo(0,0)},10)}function c(e,t){var n=new FormData;return n.append("image-file",t.resized.blob,t.file.name),r.uploadStoryImage(e,n)}function u(e){400===e.status?n.error(o.getString("Upload failed, Invalid file input")):n.error(o.getString("Unable to upload image file"))}e.current.isLoaded=!1,e.storiesLoaded=!1,e.feedsLoaded=!1,e.versionUrl=i.versionUrl,e.storiesConfig=angular.copy(i.stories),e.storiesNav={currentPage:1,perPage:e.storiesConfig.stories_per_page||5},e.feedsNav={currentPage:1,perPage:e.storiesConfig.feeds_count||10},e.storiesParams={self_only:!1},e.$watch("current.assignment.ministry_id",function(t,n){"undefined"!=typeof t&&(e.current.canAccessCurrentTab()?(e.current.isLoaded=!0,e.searchStories(1,e.storiesParams),e.loadNewsFeeds(1)):e.current.redirectToHomeTab())}),e.loadNewsFeeds=function(t){e.feedsLoaded=!1;var i={ministry_id:e.current.assignment.ministry_id,per_page:e.storiesConfig.feeds_count||10,page:t||1};r.getNewsFeeds(i).success(function(t){e.feedsLoaded=!0,e.recentNewsFeeds=t.entries,e.feedsNav.totalItems=t.meta.total,e.feedsNav.currentPage=t.meta.page}).error(function(t){e.feedsLoaded=!0,n.error(o.getString("Error loading news feeds"))})},e.searchStories=function(t,i){e.storiesLoaded=!1;var a={ministry_id:e.current.assignment.ministry_id,per_page:e.storiesConfig.stories_per_page||5,page:t||1,self_only:!1};"undefined"!=typeof i&&(a.self_only=i.self_only),r.searchStories(a).success(function(t){e.storiesLoaded=!0,e.visibleStories=t.stories,e.storiesNav.totalItems=t.meta.total,e.storiesNav.currentPage=t.meta.page}).error(function(t){e.storiesLoaded=!0,n.error(o.getString("Unable to load stories"))})},e.newStory=function(){t.open({templateUrl:"partials/stories/new-story-dialog.html",size:"lg",controller:["$scope","$modalInstance","modalData",function(e,t,n){e.story={},e.imageFile={},e.storiesConfig=n.storiesConfig,e.close=function(){t.dismiss("cancel")},e.removeImage=function(){angular.element("#image-file").val(""),e.imageFile={}},e.saveStory=function(n){t.close({story:n,imageFile:e.imageFile})}}],resolve:{modalData:function(){return{storiesConfig:angular.copy(e.storiesConfig)}}}}).result.then(function(t){var i=angular.copy(e.storiesParams);r.createStory(t.story).success(function(r){r.created_at=a("date")(new Date,"yyyy-MM-dd"),n.success(o.getString("Story saved successfully")),"undefined"!=typeof t.imageFile.resized&&c(r.story_id,t.imageFile).success(function(t){n.success(o.getString("Image file was uploaded"));var r=_.findWhere(e.visibleStories,{story_id:t.story_id});void 0!==r&&(r.image_url=t.image_url)}).error(function(e){u(e)}),1===e.storiesNav.currentPage&&angular.equals(i,e.storiesParams)&&(0===e.visibleStories.length?e.visibleStories=r:e.visibleStories.push(r))}).error(function(){n.error(o.getString("Failed to save story"))})}),s()},e.viewStory=function(n){t.open({templateUrl:"partials/stories/view-story-dialog.html",size:"lg",controller:["$scope","$modalInstance","modalData",function(e,t,n){e.story=n.story,e.versionUrl=n.versionUrl,e.isSelfOnlyEnabled=n.self_only,e.close=function(){t.dismiss("cancel")}}],resolve:{modalData:function(){return{story:angular.copy(n),versionUrl:e.versionUrl,self_only:angular.copy(e.storiesParams.self_only)}}}}),s()},e.editStory=function(i){var a=i;t.open({templateUrl:"partials/stories/edit-story-dialog.html",size:"lg",controller:["$scope","$modalInstance","modalData",function(e,t,n){e.story=n.story,e.storiesConfig=n.storiesConfig,e.imageFile={},"undefined"!=typeof e.story.image_url&&""!==e.story.image_url&&(e.imageFile.url=e.story.image_url+"?v="+e.story.updated_at),e.close=function(){t.dismiss("cancel")},e.updateStory=function(n){t.close({editStory:n,imageFile:e.imageFile})}}],resolve:{modalData:function(){return{storiesConfig:angular.copy(e.storiesConfig),story:angular.copy(i)}}}}).result.then(function(e){delete e.editStory.church_id,delete e.editStory.training_id,r.updateStory(e.editStory).success(function(t){n.success(o.getString("Story was updated")),angular.extend(a,t),"undefined"!=typeof e.imageFile.resized&&c(t.story_id,e.imageFile).success(function(e){angular.extend(a,e),n.success(o.getString("Image file was uploaded"))}).error(function(e){u(e)})}).error(function(e){n.error(o.getString("Unable to update story"))})}),s()},e.isStoryEditable=function(t){return t.ministry_id===e.current.assignment.ministry_id&&e.current.hasRole(["admin","inherited_admin","leader","inherited_leader"])?!0:e.current.user.person_id===t.created_by}}e.$inject=["$scope","$modal","growl","Stories","Settings","$filter","gettextCatalog"],angular.module("gma.controllers.stories").controller("StoriesCtrl",e)}(),function(){"use strict";function e(e,t){return{DIM:{guid:"dimension1",ministry_id:"dimension2",mcc:"dimension3",period:"dimension4",perm_link:"dimension5",church_id:"dimension6",training_id:"dimension7"},init:function(){t.googleAnalytics!==!1&&(ga("create",t.googleAnalytics,"auto"),ga("set",{appName:"GMA ("+t.appEnvironment+")",appId:"com.expidev.javascript."+t.appEnvironment,appVersion:t.version,appInstallerId:e.host()}))},screen:function(e,n){t.googleAnalytics!==!1&&(n="undefined"!=typeof n?n:{},n.screenName=e,ga("send","screenview",n))},event:function(e,n,r){t.googleAnalytics!==!1&&(r="undefined"!=typeof r?r:{},ga("send","event",e,n,r))}}}e.$inject=["$location","Settings"],angular.module("gma.services.googleAnalytics").factory("GoogleAnalytics",e)}(),function(){"use strict";function e(e,t){return e(t.api.measurements("/assignments/:assignment_id"),{assignment_id:"@assignment_id"},{getAssignment:{method:"GET"},getAssignments:{method:"GET",isArray:!0},saveAssignment:{method:"PUT"},addTeamMember:{method:"POST"}})}e.$inject=["$resource","Settings"],angular.module("gma.services.measurements").factory("Assignments",e)}(),function(){"use strict";function e(e,t){return e(t.api.measurements("/churches/:church_id"),{},{getChurch:{method:"GET"},getChurches:{method:"GET",isArray:!0},addChurch:{method:"POST"},saveChurch:{method:"PUT",params:{church_id:"@id"}}})}e.$inject=["$resource","Settings"],angular.module("gma.services.measurements").factory("Churches",e)}(),function(){"use strict";function e(e,t){return{getCountries:function(){return e.get(t.api.measurements("/iso_countries"))}}}e.$inject=["$http","Settings"],angular.module("gma.services.measurements").factory("ISOCountries",e)}(),function(){"use strict";function e(e,t){return{getLanguages:function(){return e.get(t.api.measurements("/languages"))}}}e.$inject=["$http","Settings"],angular.module("gma.services.measurements").factory("Languages",e)}(),function(){"use strict";function e(e,t){return e(t.api.measurements("/measurement_types/:measurement_type_id"),{},{getMeasurementType:{method:"GET",params:{measurement_type_id:"@measurement_type_id",ministry_id:"@ministry_id",locale:"@locale"}},getMeasurementTypes:{method:"GET",isArray:!0,params:{ministry_id:"@ministry_id",locale:"@locale"}},updateMeasurementType:{method:"PUT",params:{measurement_type_id:"@measurement_type_id",ministry_id:"@ministry_id",locale:"@locale"}},addMeasurementType:{method:"POST",params:{ministry_id:"@ministry_id",locale:"@locale"}}})}e.$inject=["$resource","Settings"],angular.module("gma.services.measurements").factory("MeasurementTypes",e)}(),function(){"use strict";function e(e,t){return e(t.api.measurements("/measurements/:perm_link_stub"),{},{getMeasurement:{method:"GET"},getMeasurements:{method:"GET",isArray:!0,params:{source:t.gmaNamespace}},saveMeasurement:{method:"POST"}})}e.$inject=["$resource","Settings"],angular.module("gma.services.measurements").factory("Measurements",e)}(),function(){"use strict";function e(e,t){return e(t.api.measurements("/ministries/:ministry_id"),{},{getMinistry:{method:"GET"},getMinistries:{method:"GET",isArray:!0},updateMinistry:{method:"PUT",params:{ministry_id:"@ministry_id"}},createMinistry:{method:"POST"}})}e.$inject=["$resource","Settings"],angular.module("gma.services.measurements").factory("Ministries",e)}(),function(){"use strict";function e(e,t,n,r,i,a){var o,s=function(n){return"false"===n?(window.location=i.api.login,!1):t.get("$http").get(i.api.measurements("/token"),{params:{st:n}}).then(function(t){return e.current.user=t.data.user,e.current.sessionToken=t.data.session_ticket,"object"==typeof t.data.user_preferences?e.current.user_preferences=t.data.user_preferences:delete e.current.user_preferences,o=t.data.session_ticket,"object"==typeof t.data.assignments&&t.data.assignments.length?e.current.assignments=t.data.assignments:delete e.current.assignments,e.$broadcast("sessionStart",t.data),t.data})};return{startSession:function(e){s(e)},logout:function(){return t.get("$http")["delete"](i.api.measurements("/token"))},request:function(e){return-1!==e.url.indexOf(i.api.measurements())&&(e.withCredentials=!0,"undefined"!=typeof o&&(e.headers.Authorization="Bearer "+o),e.attempts="number"==typeof e.attempts?e.attempts+1:1),e},responseError:function(e){if(401===e.status&&-1!==e.config.url.indexOf(i.api.measurements())&&e.config.attempts<2){var r=n.defer();return t.get("$http").get(i.api.refresh,{withCredentials:!0}).then(function(n){n.data?s(n.data.service_ticket).then(function(){t.get("$http")(e.config).then(function(e){r.resolve(e)},function(e){r.reject()})},function(){a.path("/error/invalid_session")}):r.reject()},function(e){r.reject(),a.path("/error/invalid_session")}),r.promise}return n.reject(e)}}}e.$inject=["$rootScope","$injector","$q","$log","Settings","$location"],angular.module("gma.services.measurements").factory("Session",e)}(),function(){"use strict";function e(e,t){return{createTargetCity:function(n){return e.post(t.api.measurements("/target_cities"),n)},updateTargetCity:function(n){return e.put(t.api.measurements("/target_cities/"+n.target_city_id),n)},getTargetCity:function(n){return e.get(t.api.measurements("/target_cities/"+n))},deleteTargetCity:function(n){return e["delete"](t.api.measurements("/target_cities/"+n))},searchTargetCities:function(n){return e.get(t.api.measurements("/target_cities"),{params:n})}}}e.$inject=["$http","Settings"],angular.module("gma.services.measurements").factory("TargetCity",e)}(),function(){"use strict";function e(e,t){function n(e){var t=0;if(!e)return 0;for(var n=0;n<e.length;n++)e[n].phase>(t||0)&&(t=e[n].phase);return t}function r(e){for(var t=0,n=0;n<e.length;n++)e[n].number_completed>(t||0)&&(t=e[n].number_completed);return t}return{getTrainings:function(i,a,o,s,c){return e.get(t.api.measurements("/training"),{params:{ministry_id:a,show_all:s,show_tree:c,mcc:o}}).then(function(e){return angular.forEach(e.data,function(e){e.current_stage=n(e.gcm_training_completions)+1,e.leaders_trained=r(e.gcm_training_completions),e.editMode=!1}),e.data})},updateTraining:function(n,r){return e.put(t.api.measurements("/training/"+r.id),r).then(function(e){return e.data})},addTraining:function(n,r){return e.post(t.api.measurements("/training"),r).then(function(e){return e.data})},deleteTraining:function(n,r){return e["delete"](t.api.measurements("/training/"+r.id)).then(function(e){if(204===e.status)return e;throw e})},addTrainingCompletion:function(n,r){return e.post(t.api.measurements("/training_completion"),r).then(function(e){return e.data})},updateTrainingCompletion:function(n,r){return e.put(t.api.measurements("/training_completion/"+r.id),r).then(function(e){return e.data})},deleteTrainingCompletion:function(n,r){return e["delete"](t.api.measurements("/training_completion/"+r.id)).then(function(e){if(204===e.status)return e;throw e})}}}e.$inject=["$http","Settings"],angular.module("gma.services.measurements").factory("Trainings",e)}(),function(){"use strict";function e(e,t){return{getPreference:function(){return e.get(t.api.measurements("/user_preferences"))},savePreference:function(n){return e.post(t.api.measurements("/user_preferences"),n)},getFlatMinistry:function(e){function t(e){n.push(e),e.hasOwnProperty("sub_ministries")&&_.size(e.sub_ministries)>0&&angular.forEach(e.sub_ministries,t)}var n=[];return angular.forEach(e,t),_.uniq(n,!1,function(e){return e.ministry_id})},getMappedMCCS:function(e,t){var n=[];return _.each(e,function(e){var r={};r.mcc=e,r.mccLabel=t[e],n.push(r)}),n}}}e.$inject=["$http","Settings"],angular.module("gma.services.preference").factory("UserPreference",e)}(),function(){"use strict";function e(e){function t(e,t){return"undefined"==typeof t?e:0===t.indexOf("/")?e+t:e+"/"+t}var n={},r=[];this.setConfig=function(e){n=e};var i=function(e){return-1===e.indexOf("?")?e+"?ver="+n.version:e+"&ver="+n.version},a=function(e,r){r="undefined"==typeof r?!0:r;var a=t(n.appUrl,e);return r?i(a):a},o=function(e){return t(n.api.measurements,e)};this.routes=function(){return angular.forEach(n.tabs,function(t){switch(t){case"map":this.push({name:e("Map"),path:"/map",icon:"glyphicon-map-marker",templateUrl:"partials/map/map.html",controller:"MapCtrl",requiredRoles:["admin","inherited_admin","self_assigned","member","inherited_leader","leader"]});break;case"measurements":this.push({name:e("Measurements"),path:"/measurements",icon:"glyphicon-stats",templateUrl:"partials/measurements/measurements.html",controller:"MeasurementsCtrl",requiredRoles:["admin","inherited_admin","self_assigned","member","inherited_leader","leader"]});break;case"reports":this.push({name:e("Reports"),path:"/reports",icon:"glyphicon-list-alt",templateUrl:"partials/reports/reports.html",controller:"ReportsCtrl",requiredRoles:["admin","inherited_admin","inherited_leader","leader"]});break;case"admin":this.push({name:e("Admin"),path:"/admin",icon:"glyphicon-cog",templateUrl:"partials/admin/admin.html",controller:"AdminCtrl",requiredRoles:["admin","inherited_admin","leader","inherited_leader"]});break;case"news":this.push({name:e("Home"),path:"/news",icon:"glyphicon-home",templateUrl:"partials/stories/stories.html",controller:"StoriesCtrl",requiredRoles:["admin","inherited_admin","inherited_leader","leader","member"]})}},r),r},this.$get=function(){return{appUrl:a,versionUrl:i,version:n.version,name:n.name,ticket:n.ticket,appEnvironment:n.environment,api:{measurements:o,refresh:n.api.refresh,logout:n.api.logout,login:n.api.login},mobileApps:"object"==typeof n.mobileapps&&Object.keys(n.mobileapps).length>0?n.mobileapps:!1,gmaNamespace:n.namespace,tabs:r,googleAnalytics:n.googleanalytics,default_measurement_states:n.default_measurement_states||{},stories:n.stories,area_codes:n.area_codes,static_locales:n.static_locales}}}e.$inject=["gettext"],angular.module("gma.services.settings").provider("Settings",e)}(),function(){"use strict";function e(e,t){return{getStory:function(n){return e.get(t.api.measurements("/stories")+"/"+n)},searchStories:function(n){return e.get(t.api.measurements("/stories"),{params:n})},createStory:function(n){return e.post(t.api.measurements("/stories"),n)},updateStory:function(n){return e.put(t.api.measurements("/stories")+"/"+n.story_id,n)},uploadStoryImage:function(n,r){return e.post(t.api.measurements("/images?story_id="+n),r,{headers:{"Content-Type":void 0},transformRequest:angular.identity})},getNewsFeeds:function(n){return e.get(t.api.measurements("/audit"),{params:n})}}}e.$inject=["$http","Settings"],angular.module("gma.services.stories").factory("Stories",e)}();
//# sourceMappingURL=application.min.js.map
