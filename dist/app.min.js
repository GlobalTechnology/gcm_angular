angular.module("app.settings",[]).provider("settings",function(){function e(e,n){return"undefined"==typeof n?e:0===n.indexOf("/")?e+n:e+"/"+n}var n={};this.setConfig=function(e){n=e};var t=function(t,r){var r="undefined"==typeof r?!0:!1,i=e(n.appUrl,t);return r?i+"?ver="+n.version:i},r=function(t){return e(n.api.measurements,t)};this.routes=function(){var e=[];return angular.forEach(n.enabled_tabs,function(n){switch(n){case"map":e.push({name:"Church",path:"/map",templateUrl:t("/template/map.html"),controller:"mapController",requiredRoles:["self_assigned","member","inherited_leader","leader"]});break;case"measurements":e.push({name:"Measurements",path:"/measurements",templateUrl:t("/template/measurements.html"),controller:"measurementsController",requiredRoles:["self_assigned","member","inherited_leader","leader"]});break;case"reports":e.push({name:"Reports",path:"/reports",templateUrl:t("/template/reports.html"),controller:"ReportsController",requiredRoles:["inherited_leader","leader"]});break;case"admin":e.push({name:"Admin",path:"/admin",templateUrl:t("/template/admin.html"),controller:"adminController",requiredRoles:["leader","inherited_leader"]})}}),n.enabledTabs=e,e},this.$get=function(){return{appUrl:t,ticket:n.ticket,api:{measurements:r,refresh:n.api.refresh,logout:n.api.logout,login:n.api.login},mobileApps:"undefined"!=typeof n.mobileapps&&n.mobileapps.length>0?n.mobileapps:!1,gmaNamespace:n.namespace,enabledTabs:n.enabledTabs}}}),angular.module("app",["ngRoute","ui.bootstrap","ngResource","app.settings"]).run(["$rootScope","$route","sessionService","settings",function(e,n,t,r){e.current={isLoaded:!1},e.visibleTabs=r.enabledTabs,n.reload(),t.startSession(r.ticket)}]).config(["$routeProvider","$httpProvider","$compileProvider","settingsProvider","$provide",function(e,n,t,r,i){r.setConfig(window.gma.config),t.aHrefSanitizationWhitelist(/^\s*(https?|ftp|mailto|tel|file|itms-services):/),n.interceptors.push("sessionService"),angular.forEach(r.routes(),function(n,t){0===t&&e.otherwise({redirectTo:n.path}),e.when(n.path,{templateUrl:n.templateUrl,controller:n.controller})}),i.decorator("ngModelDirective",["$delegate",function(e){var n=e[0],t=n.controller;return n.controller=["$scope","$element","$attrs","$injector",function(e,n,r,i){var a=i.get("$interpolate");r.$set("name",a(r.name||"")(e)),i.invoke(t,this,{$scope:e,$element:n,$attrs:r})}],e}]),i.decorator("formDirective",["$delegate",function(e){var n=e[0],t=n.controller;return n.controller=["$scope","$element","$attrs","$injector",function(e,n,r,i){var a=i.get("$interpolate");r.$set("name",a(r.name||r.ngForm||"")(e)),i.invoke(t,this,{$scope:e,$element:n,$attrs:r})}],e}])}]),angular.module("app").controller("adminController",["$scope","$modal","$filter","assignmentService","ministryService","measurementTypeService",function(e,n,t,r,i,a){e.current.isLoaded=!1,e.roles=[{value:"leader",text:"Leader"},{value:"inherited_leader",text:"Leader (inherited)"},{value:"member",text:"Member"},{value:"blocked",text:"Blocked"},{value:"self_assigned",text:"Self Assigned"}],e.$watch("current.assignment.ministry_id",function(n){"undefined"!=typeof n&&(e.ministry=i.getMinistry({ministry_id:n},function(){e.current.isLoaded=!0,e.measurementTypes=[],a.getMeasurementTypes().$promise.then(function(n){angular.forEach(n,function(n){n.visible=n.is_custom&&_.contains(e.ministry.lmi_show,n.perm_link_stub)?!0:n.is_custom||_.contains(e.ministry.lmi_hide,n.perm_link_stub)?!1:!0,e.measurementTypes.push(n)})})}))}),e.saveRole=function(e){r.saveAssignment({assignment_id:e.assignment_id},{team_role:e.team_role})},e.ableToChangeParentMinistry=function(n){var r=_.pluck(t("roleFilter")(e.current.ministries,["leader","inherited_leader"]),"ministry_id");return _.contains(r,n)},e.addTeamMember=function(){n.open({templateUrl:"add_team_member.html",controller:["$scope","$modalInstance","roles",function(e,n,t){e.roles=t,e.close=function(){n.dismiss()},e.add=function(){n.close(e.newMember)}}],resolve:{roles:function(){return e.roles}}}).result.then(function(n){n.ministry_id=e.current.assignment.ministry_id,r.addTeamMember(n,function(){e.ministry=i.getMinistry({ministry_id:e.current.assignment.ministry_id})})})},e.addSubMinistry=function(){n.open({templateUrl:"add_sub_ministry.html",controller:["$scope","$modalInstance",function(e,n){e.close=function(){n.dismiss()},e.add=function(){n.close(e.newMinistry)}}]}).result.then(function(n){n.parent_id=e.current.assignment.ministry_id,i.createMinistry(n,function(){angular.isDefined(e.current.assignment.sub_ministries)?e.current.assignment.sub_ministries.push(n):e.current.assignment.sub_ministries=[n]})})},e.addMeasurement=function(){n.open({templateUrl:"add_measurement_type.html",controller:["$scope","$modalInstance",function(e,n){e.close=function(){n.dismiss()},e.add=function(){n.close(e.newMeasurement)}}]}).result.then(function(e){e.perm_link_stub="custom_"+e.perm_link_stub,a.addMeasurementType(e,function(){})})},e.saveDetails=function(){var n={ministry_id:e.ministry.ministry_id,min_code:e.ministry.min_code,name:e.ministry.name,has_ds:e.ministry.has_ds,has_gcm:e.ministry.has_gcm,has_llm:e.ministry.has_llm,has_slm:e.ministry.has_slm,"private":e.ministry["private"],lmi_hide:_.pluck(_.where(e.measurementTypes,{is_custom:!1,visible:!1}),"perm_link_stub"),lmi_show:_.pluck(_.where(e.measurementTypes,{is_custom:!0,visible:!0}),"perm_link_stub")};e.ministry.hasOwnProperty("parent_id")&&"string"==typeof e.ministry.parent_id&&(n.parent_id=e.ministry.parent_id),e.saveDetailsResource=i.updateMinistry(n,function(){e.saveDetailsAlert={type:"success",msg:"Your changes have been saved."}},function(n){e.saveDetailsAlert={type:"danger",msg:n.Message||"An error occurred while saving."}})}}]),angular.module("app").controller("gcmController",["$scope","$filter","$location","$modal","sessionService","ministryService","assignmentService","settings","$log",function(e,n,t,r,i,a,o,s,c){function u(e){var n=[];return angular.forEach(e,function(e){n.push(e),e.hasOwnProperty("sub_ministries")&&"object"==typeof e.sub_ministries&&(n=n.concat(u(e.sub_ministries)))}),n=_.sortBy(n,function(e){return"leader"===e.team_role?0:1}),_.uniq(n,!1,function(e){return e.ministry_id})}e.$location=t,e.$on("sessionStart",function(n,t){"undefined"==typeof t.assignments&&e.joinMinistry(!1)}),e.$watch("current.assignments",function(t,r){t!==r&&(c.debug("Assignments Changed"),"object"==typeof t?((angular.isUndefined(e.current.assignment)||!_.contains(_.pluck(t,"id"),e.current.assignment.id))&&(e.current.assignment=n("orderBy")(t,"name")[0]),e.current.ministries=u(t)):(delete e.current.assignment,e.current.ministries=[]))}),e.$watch("current.assignment",function(t,r){t!==r&&(c.debug("Assignment Changed: "+t.name),"object"==typeof t&&(t.mccs.length>0?("undefined"==typeof e.current.mcc||t.mccs.indexOf(e.current.mcc)<0)&&(e.current.mcc=n("orderBy")(t.mccs,e.mccSort)[0]):delete e.current.mcc))}),e.current.hasRole=function(n){return"undefined"==typeof e.current.assignment||"undefined"==typeof e.current.assignment.team_role?!1:"string"==typeof n?n==e.current.assignment.team_role:_.contains(n,e.current.assignment.team_role)},e.mccLabels={ds:"Digital Strategies",gcm:"Global Church Movements",llm:"Leader Led",slm:"Student Led"},e.mccSort=function(n){return e.mccLabels[n]};for(var l=[],m=moment().date(1),d=0;12>d;d++)l.push(m.clone()),m.subtract(1,"M");e.periods=l,e.current.period=l[0],e.prevPeriod=function(){var n=e.periods.indexOf(e.current.period);n=n+1>=e.periods.length?0:n+1,e.current.period=e.periods[n]},e.nextPeriod=function(){var n=e.periods.indexOf(e.current.period);n=0>n-1?e.periods.length-1:n-1,e.current.period=e.periods[n]},e.logout=function(){i.logout().then(function(){window.location=s.api.logout})},e.invalidateSession=function(){i.logout()},e.joinMinistry=function(n){n="undefined"!=typeof n?n:!0;var t=r.open({templateUrl:"join_ministry.html",controller:"joinMinistryController",keyboard:n,backdrop:n?!0:"static",resolve:{ministries:function(){return a.getMinistries().$promise},allowClose:function(){return n}}});t.result.then(function(n){o.addTeamMember({username:e.current.user.cas_username,ministry_id:n.ministry_id,team_role:"self_assigned"},function(n){"undefined"==typeof e.current.assignments?e.current.assignments=[n]:(e.current.assignments.push(n),e.current.assignment=n)})})},e.onError=function(n,t){401==t&&n.hasOwnProperty("reason")&&"SESSION_INVALID"==n.reason&&(window.location=window.location.pathname),e.error=n.reason},e.mobileApps=s.mobileApps}]).controller("joinMinistryController",["$scope","$modalInstance","ministries","allowClose",function(e,n,t,r){e.ministries=t,e.allowClose=r,e.join=function(){n.close(e.ministry)},e.cancel=function(){n.dismiss("cancel")}}]).filter("roleFilter",[function(){return function(e,n){var t=[];return angular.forEach(e,function(e){"string"==typeof n&&n==e.team_role?t.push(e):"object"==typeof n&&_.contains(n,e.team_role)&&t.push(e)}),t}}]),function(e){angular.module("app").controller("mapController",["$scope","$document","$compile","trainingService","churchService","ministryService","settings",function(n,t,r,i,a,o,s){function c(){n.map=new google.maps.Map(document.getElementById("map_canvas"),n.mapOptions),n.map.setOptions({draggableCursor:""}),google.maps.event.addListener(n.map,"idle",function(){n.current.isLoaded=!0;var e=n.map.getBounds(),t=e.getNorthEast(),r=e.getSouthWest();t.lat()==r.lat()&&t.lng()==r.lng()?google.maps.event.trigger(n.map,"resize"):n.loadChurches()}),n.map.markers=[],n.church={name:""},n.churchWindow=new google.maps.InfoWindow,n.churchWindowContent=r('<div id="church_window_content" ng-include="appUrl(\'/template/edit_church_window.html\')"></div>')(n),n.churchWindow.setOptions({maxWidth:300}),n.trainingWindow=new google.maps.InfoWindow,n.trainingWindowContent=r('<div id="training_window_content" ng-include="appUrl(\'/template/edit_training.html\')"></div>')(n),n.trainingWindow.setOptions({maxWidth:400}),n.newChurchWindow=new google.maps.InfoWindow,google.maps.event.addListener(n.newChurchWindow,"closeclick",function(){n.cancelAddChurch()}),n.newChurchWindowContent=r('<div id="new_church_window_content" ng-include="appUrl(\'/template/new_church_window.html\')"></div>')(n),n.newTrainingWindow=new google.maps.InfoWindow,google.maps.event.addListener(n.newTrainingWindow,"closeclick",function(){n.cancelAddChurch()}),n.newTrainingContent=r('<div id="new_training_window_content" ng-include="appUrl(\'/template/new_training.html\')"></div>')(n),n.map.church_lines=[],n.map.icons={},n.map.icons.church=new google.maps.MarkerImage(s.appUrl("/css/map_icons/church.png"),new google.maps.Size(60,60),new google.maps.Point(0,0),new google.maps.Point(30,58)),n.map.icons.cluster=new google.maps.MarkerImage(s.appUrl("/css/map_icons/cluster.png"),new google.maps.Size(60,60),new google.maps.Point(0,0),new google.maps.Point(30,31)),n.map.icons.multiplying=new google.maps.MarkerImage(s.appUrl("/css/map_icons/multiplying.png"),new google.maps.Size(60,60),new google.maps.Point(0,0),new google.maps.Point(30,53)),n.map.icons.group=new google.maps.MarkerImage(s.appUrl("/css/map_icons/group.png"),new google.maps.Size(60,60),new google.maps.Point(0,0),new google.maps.Point(30,55)),n.map.icons.targetpoint=new google.maps.MarkerImage(s.appUrl("/css/map_icons/target.png"),new google.maps.Size(60,60),new google.maps.Point(0,0),new google.maps.Point(32,56)),n.map.icons.training=new google.maps.MarkerImage(s.appUrl("/css/map_icons/training.png"),new google.maps.Size(60,60),new google.maps.Point(0,0),new google.maps.Point(30,43)),n.map.side=document.getElementById("side"),n.map.side.index=-1,n.map.side.style.display="block",n.map.search=document.getElementById("map_controls"),n.map.search.index=3,n.map.search.style.display="block",n.map.controls[google.maps.ControlPosition.TOP_RIGHT].push(n.map.side),n.map.controls[google.maps.ControlPosition.TOP_LEFT].push(n.map.search),n.current.assignment&&n.load_training_markers(),n.$watch("current.assignment",function(e){"undefined"!=typeof e&&(e&&e.hasOwnProperty("location")&&n.map.setCenter(new google.maps.LatLng(e.location.latitude,e.location.longitude)),e&&e.hasOwnProperty("location_zoom")&&n.map.setZoom(parseInt(e.location_zoom)))},!0)}n.current.isLoaded=!1,n.appUrl=s.appUrl,n.show_target_point=!0,n.show_group=!0,n.show_church=!0,n.show_mult_church=!0,n.show_lines=!0,n.show_lines=!0,n.show_jf=!0,n.map_filter="min_only",n.icon_add_mode=!1,n.show_all="year",n.show_tree=!1,n.new_church={},n.edit_church={},n.SetParentMode=!1,n.church_lines=[],n.churches=[],n.trainings=[],n.allChurches=[],n.training_types=[{value:"MC2",text:"MC2"},{value:"T4T",text:"T4T"},{value:"CPMI",text:"CPMI"},{value:"",text:"Other"}],n.show={training:!0},n.mapOptions={zoom:3,center:new google.maps.LatLng(0,0),panControl:!0,zoomControl:!0,mapTypeControl:!0,streetViewControl:!1,overviewMapControl:!1},setTimeout(c,0),n.$watch("current.assignment.ministry_id",function(e){"undefined"==typeof e?(n.allChurches=[],n.trainings=[]):(n.loadAllChurches(),n.loadTrainings())}),n.$watch("searchedChurch",function(e){if("undefined"!=typeof e&&""!=e){var t=n.map.markers.filter(function(n){return n.id==e.id});if(t.length>0){var r=t[0];google.maps.event.trigger(r,"click")}else n.map.setCenter(new google.maps.LatLng(e.latitude,e.longitude))}}),n.$watch("map_filter",function(){n.loadAllChurches(),n.loadTrainings()}),n.$watch("current.mcc",function(e){"undefined"==typeof e?n.trainings=[]:n.loadTrainings()}),n.loadAllChurches=_.debounce(function(){if("undefined"!=typeof n.current.assignment){var e={ministry_id:n.current.assignment.ministry_id};"everything"===n.map_filter?e.show_all="true":"tree"===n.map_filter&&(e.show_tree="true"),n.allChurches=a.getChurches(e)}},500),n.loadTrainings=_.debounce(function(){"undefined"!=typeof n.current.assignment&&n.current.hasRole(["leader","inherited_leader"])?i.getTrainings(n.current.sessionToken,n.current.assignment.ministry_id,n.current.mcc,"all"==n.show_all,n.show_tree).then(function(e){n.trainings=e},n.onError):n.trainings=[]},500),n.loadChurches=_.debounce(function(){if("undefined"!=typeof n.current.assignment){console.log("loading churches");var e=n.map.getBounds(),t=e.getNorthEast(),r=e.getSouthWest(),i={ministry_id:n.current.assignment.ministry_id,lat_min:r.lat(),lat_max:t.lat(),long_min:r.lng(),long_max:t.lng()};n.show_target_point||(i.hide_target_point="true"),n.show_group||(i.hide_group="true"),n.show_church||(i.hide_church="true"),n.show_mult_church||(i.hide_mult_church="true"),"everything"===n.map_filter?i.show_all="true":"tree"===n.map_filter&&(i.show_tree="true"),n.map.getZoom()>=14&&(i.should_cluster="false"),a.getChurches(i).$promise.then(n.onGetChurches,n.onError)}},500),n.removeLines=function(){angular.forEach(n.map.church_lines,function(e){e.setMap(null)})},n.removeJF=function(){e(".jf_label").remove()},n.$watch("show_lines",function(){"undefined"!=typeof n.map&&angular.forEach(n.map.church_lines,function(e){e.setVisible(n.show_lines)})}),n.$watch("show_jf",function(){n.show_jf?e(".jf_label").show():e(".jf_label").hide()}),n.onAddChurch=function(){n.loadChurches()},n.addChurch=function(){angular.forEach(n.map.markers,function(e){if(-1==e.id){n.new_church.ministry_id=n.current.assignment.ministry_id,n.new_church.latitude=e.getPosition().lat(),n.new_church.longitude=e.getPosition().lng(),console.log(n.new_church),a.addChurch(n.new_church).$promise.then(n.onAddChurch,n.onError),e.setMap(null);var t=n.map.markers.splice(n.map.markers.indexOf(e),1);t=null}})},n.addTraining=function(){angular.forEach(n.map.markers,function(e){if(-2==e.id){n.new_training.ministry_id=n.current.assignment.ministry_id,n.new_training.latitude=e.getPosition().lat(),n.new_training.longitude=e.getPosition().lng(),n.new_training.mcc=n.current.mcc,i.addTraining(n.current.sessionToken,n.new_training).then(n.loadTrainings,n.onError),e.setMap(null);var t=n.map.markers.splice(n.map.markers.indexOf(e),1);t=null}})},n.cancelAddChurch=function(){angular.forEach(n.map.markers,function(e){if(e.id<0){e.setMap(null);var t=n.map.markers.splice(n.map.markers.indexOf(e),1);t=null}}),n.new_church={},n.new_training={}},n.onAddTraining=function(){0==n.map.markers.filter(function(e){return e.id<0}).length&&(n.new_training={},marker=new MarkerWithLabel({position:n.map.getCenter(),map:n.map,title:"new_training",id:-2,cluster_count:1,zIndex:9999,icon:n.map.icons.training,labelContent:"MOVE ME!",labelAnchor:new google.maps.Point(50,-5),labelClass:"labelMoveMarker",labelInBackground:!1,draggable:!0}),n.map.new_training_marker=marker,marker.setAnimation(google.maps.Animation.BOUNCE),n.newTrainingWindow.getContent()||n.newTrainingWindow.setContent(n.newTrainingContent[0].nextSibling),n.newTrainingWindow.open(n.map,marker),n.map.markers.push(marker))},n.onSaveChurch=function(){n.loadChurches()},n.onAddIcon=function(){0==n.map.markers.filter(function(e){return e.id<0}).length&&(n.new_church={security:2},marker=new MarkerWithLabel({position:n.map.getCenter(),map:n.map,title:"new church",id:-1,cluster_count:1,zIndex:9999,icon:n.map.icons.targetpoint,labelContent:"Move me!",labelAnchor:new google.maps.Point(50,-20),labelClass:"labelMoveMarker",labelInBackground:!1,draggable:!0}),n.map.new_marker=marker,marker.setAnimation(google.maps.Animation.BOUNCE),n.newChurchWindow.getContent()||n.newChurchWindow.setContent(n.newChurchWindowContent[0].nextSibling),n.newChurchWindow.open(n.map,marker),n.map.markers.push(marker))},n.SetParent=function(){n.SetParentMode=!0,n.churchWindow.close(),n.new_parentLine=new google.maps.Polyline({path:[new google.maps.LatLng(n.edit_church.latitude,n.edit_church.longitude),new google.maps.LatLng(n.edit_church.latitude,n.edit_church.longitude)],geodesic:!0,strokeColor:"#777",strokeOpacity:1,strokeWeight:2,icons:[{icon:{path:google.maps.SymbolPath.FORWARD_OPEN_ARROW,strokeWeight:1.5},offset:"12px",repeat:"25px"}]}),n.move_event=google.maps.event.addListener(n.map,"mousemove",function(e){n.new_parentLine.setPath([e.latLng,new google.maps.LatLng(n.edit_church.latitude,n.edit_church.longitude)])}),n.new_parentLine.setMap(n.map)},n.MoveChurch=function(){angular.forEach(n.map.markers,function(e){e.id===n.edit_church.id&&(e.setAnimation(google.maps.Animation.BOUNCE),e.setDraggable(!0),n.churchWindow.close())})},n.MoveTraining=function(){var e=n.edit_training.hasOwnProperty("Id")?n.edit_training.Id:n.edit_training.id;angular.forEach(n.map.markers,function(t){t.id==="t"+e&&(t.setAnimation(google.maps.Animation.BOUNCE),t.setDraggable(!0),n.trainingWindow.close())})},n.SaveChurch=function(){a.saveChurch(n.edit_church).$promise.then(n.onSaveChurch,n.onError)},n.SaveTraining=function(){i.updateTraining(n.current.sessionToken,n.edit_training).then(n.onSaveChurch,n.onError)},n.$watch("trainings",function(){n.map&&n.load_training_markers()}),n.load_training_markers=function(){if("undefined"!=typeof n.map){var e=[];angular.forEach(n.map.markers,function(t){"t"==t.id[0]&&0==n.trainings.filter(function(e){return e.id==t.id}).length?e.push(t):"t"!=t.id[0]||n.show.training||e.push(t)}),angular.forEach(e,function(e){e.setMap(null);var t=n.map.markers.splice(n.map.markers.indexOf(e),1);t=null}),n.show.training&&angular.forEach(n.trainings,function(e){if(0==n.map.markers.filter(function(n){return n.id==="t"+e.id}).length&&e.longitude){var t=new MarkerWithLabel({position:new google.maps.LatLng(e.latitude,e.longitude),map:n.map,id:"t"+(e.hasOwnProperty("Id")?e.Id:e.id),title:e.type,icon:n.map.icons.training,labelContent:"",labelAnchor:new google.maps.Point(30,0),labelClass:"labelMarker",labelInBackground:!1,draggable:!1});n.trainingWindow.getContent()||n.trainingWindow.setContent(n.trainingWindowContent[0].nextSibling),google.maps.event.addListener(t,"click",function(e,t){return function(){n.edit_training=e,n.edit_training.editable=("leader"===n.current.assignment.team_role||"inherited_leader"===n.current.assignment.team_role)&&e.ministry_id===n.current.assignment.ministry_id,n.$apply(),n.trainingWindow.close(),n.trainingWindow.setOptions({maxWidth:400}),n.trainingWindow.open(n.map,t)}}(e,t,n)),google.maps.event.addListener(t,"dragend",function(){console.log(t),e.latitude=t.getPosition().lat(),e.longitude=t.getPosition().lng(),i.updateTraining(n.current.sessionToken,e).then(n.onSaveChurch,n.onError),t.setAnimation(null),t.setDraggable(!1)}),n.map.markers.push(t)}})}},n.$watch("show.training",n.load_training_markers,!0),n.onGetChurches=function(e){n.churches=e,console.log("got churches"),n.removeLines(),n.removeJF();var t=[];angular.forEach(n.map.markers,function(n){n.id>0&&(0==e.filter(function(e){return e.id==n.id&&1==e.cluster_count}).length||n.cluster_count>1)&&t.push(n)}),angular.forEach(t,function(e){e.setMap(null);var t=n.map.markers.splice(n.map.markers.indexOf(e),1);t=null}),angular.forEach(n.churches,function(e){if(0==n.map.markers.filter(function(n){return n.id==e.id}).length){var t={};if(1==e.cluster_count){var r={};r=5==e.development?n.map.icons.multiplying:4==e.development?n.map.icons.church:3==e.development?n.map.icons.church:2==e.development?n.map.icons.group:1==e.development?n.map.icons.targetpoint:n.map.icons.church,t=new MarkerWithLabel({position:new google.maps.LatLng(e.latitude,e.longitude),map:n.map,title:e.name,id:e.id,cluster_count:e.cluster_count,icon:r,labelContent:e.name,labelAnchor:new google.maps.Point(30,0),labelClass:"labelMarker",labelInBackground:!1,draggable:!1}),e.jf_contrib>0&&(e.jf=new n.jesusFilmSign(new google.maps.LatLng(e.latitude,e.longitude),e.jf_contrib,e.development))}else t=new MarkerWithLabel({position:new google.maps.LatLng(e.latitude,e.longitude),map:n.map,id:e.id,cluster_count:e.cluster_count,icon:n.map.icons.cluster,labelContent:e.cluster_count.toString(),labelAnchor:new google.maps.Point(30,15),labelClass:"clusterMarker",labelInBackground:!1}),e.jf_contrib>0&&(e.jf=new n.jesusFilmSign(new google.maps.LatLng(e.latitude,e.longitude),e.jf_contrib,"cluster"));n.churchWindow.getContent()||n.churchWindow.setContent(n.churchWindowContent[0].nextSibling),google.maps.event.addListener(t,"click",function(e,t){return function(){if(n.SetParentMode){if(1==e.cluster_count&&e.id!==n.edit_church.id){google.maps.event.removeListener(n.move_event),n.SetParentMode=!1,n.new_parentLine.setPath([new google.maps.LatLng(e.latitude,e.longitude),new google.maps.LatLng(n.edit_church.latitude,n.edit_church.longitude)]);var r={};r.id=n.edit_church.id,r.parent_id=e.id,n.edit_church.parent_id=e.id,console.log(r),a.saveChurch(r).$promise.then(n.onSaveChurch,n.onError)}}else 1==e.cluster_count?(n.edit_church=e,n.edit_church.editable=("leader"===n.current.assignment.team_role||"inherited_leader"===n.current.assignment.team_role)&&e.ministry_id===n.current.assignment.ministry_id,n.$apply(),n.churchWindow.close(),n.churchWindow.setOptions({maxWidth:300}),n.churchWindow.open(n.map,t)):(n.map.setCenter(t.position),n.map.setZoom(n.map.getZoom()+2))}}(e,t,n)),google.maps.event.addListener(t,"dragend",function(e,t){return function(){if(1==e.cluster_count){var r={};r.id=e.id,r.latitude=t.getPosition().lat(),r.longitude=t.getPosition().lng(),e.latitude=r.latitude,e.longitude=r.longitude,a.saveChurch(r).$promise.then(n.onSaveChurch,n.onError),t.setAnimation(null),t.setDraggable(!1)}}}(e,t)),n.map.markers.push(t)}angular.forEach(e.parents,function(t){var r=n.churches.filter(function(e){return e.id==t});if(r.length>0){var i=new google.maps.Polyline({path:[new google.maps.LatLng(r[0].latitude,r[0].longitude),new google.maps.LatLng(e.latitude,e.longitude)],geodesic:!0,strokeColor:"#777",strokeOpacity:1,strokeWeight:2,icons:[{icon:{path:google.maps.SymbolPath.FORWARD_OPEN_ARROW,strokeWeight:1.5},offset:"12px",repeat:"25px"}]});i.setMap(n.map),n.map.church_lines.push(i)}})})},n.jesusFilmSign=function(e,t,r){this.div_=null,this.setMap(n.map),1==t&&(t="JF"),this.onAdd=function(){var e=document.createElement("div");e.className="jf_label",e.innerHTML=t,this.div_=e;var n=this.getPanes();n.overlayMouseTarget.appendChild(e)},this.draw=function(){var n,t,i=this.div_,a=this.getProjection(),o=a.fromLatLngToDivPixel(e);"cluster"==r?(n=-20,t=8):r>=0&&1>=r?(n=-23,t=-12):2==r?(n=-22,t=-13):r>=3?(n=-20,t=-13):(n=0,t=0),i.style.left=o.x+n+"px",i.style.top=o.y+t+"px"},this.onRemove=function(){this.div_.parentNode.removeChild(n.div_),this.div_=null}},n.jesusFilmSign.prototype=new google.maps.OverlayView,n.setDefaultView=function(){var e=n.map.getCenter(),t=n.map.getZoom();n.current.assignment.location={latitude:e.lat(),longitude:e.lng()},n.current.assignment.location_zoom=t,o.updateMinistry({ministry_id:n.current.assignment.ministry_id,min_code:n.current.assignment.min_code.trim(),location:n.current.assignment.location,location_zoom:n.current.assignment.location_zoom})},n.addTrainingStage=function(e){var t={phase:e.current_stage,date:e.insert.date,number_completed:e.insert.number_completed,training_id:e.hasOwnProperty("Id")?e.Id:e.id};i.addTrainingCompletion(n.current.sessionToken,t).then(n.onAddTrainingCompletion,n.onError),e.insert.date="",e.insert.number_completed=0},n.onAddTrainingCompletion=function(e){e.editMode=!1,angular.forEach(n.assignment.trainings,function(n){var t=n.hasOwnProperty("Id")?n.Id:n.id;t==e.training_id&&(n.gcm_training_completions.push(e),n.current_stage=e.phase+1)})},n.saveTrainingCompletion=function(e){i.updateTrainingCompletion(n.current.sessionToken,e).then(n.onSaveTrainingCompletion,n.onError)}}])}(jQuery),angular.module("app").controller("measurementsController",["$scope","$document","$filter","$modal","measurementService","settings",function(e,n,t,r,i,a){e.current.isLoaded=!1,e.ns=a.gmaNamespace;var o=_.debounce(function(){"undefined"!=typeof e.current.assignment&&"undefined"!=typeof e.current.period&&"undefined"!=typeof e.current.mcc&&(e.current.isLoaded=!1,e.lmiForm.$setPristine(),e.measurements=i.getMeasurements({ministry_id:e.current.assignment.ministry_id,mcc:e.current.mcc,period:e.current.period.format("YYYY-MM")},function(){e.current.isLoaded=!0}))},100);e.$watch("current.assignment.ministry_id",function(){o()}),e.$watch("current.mcc",function(){o()}),e.$watch("current.period",function(){o()}),e.hasOther=function(){return _.where(e.measurements,{section:"other",column:"other"}).length>0},e.save=function(){var n=[];angular.forEach(e.measurements,function(n){var t=e.lmiForm[n.perm_link];t.$dirty&&t.$valid&&this.push({period:e.current.period.format("YYYY-MM"),mcc:e.current.mcc+"_"+a.gmaNamespace,measurement_type_id:n.measurement_type_ids.person,related_entity_id:e.current.assignment.id,value:t.$modelValue})},n),n.length>0?i.saveMeasurement({},n,function(){o()}):o()},e.editMeasurementDetails=function(n){var t=r.open({templateUrl:"measurement_details.html",controller:"measurementDetailsController",keyboard:!0,backdrop:!0,resolve:{measurement:function(){return n},details:function(){return i.getMeasurement({measurement_id:n.measurement_id,ministry_id:e.current.assignment.ministry_id,mcc:e.current.mcc,period:e.current.period.format("YYYY-MM")})}}});t.result.then(function(){o()})}}]).directive("measurementsTrend",[function(){return{restrict:"A",require:"ngModel",link:function(e,n,t,r){if(r){var i=new google.visualization.LineChart(n.get(0));r.$render=function(){i.draw(r.$viewValue,{width:550,height:200})},e.$on("$destroy",function(){i=null})}}}}]).controller("measurementDetailsController",["$scope","$modalInstance","measurementService","assignmentService","measurement","details","settings",function(e,n,t,r,i,a,o){e.spinner=!0,e.measurement=i,e.details=a,e.ns=o.gmaNamespace,e.details.$promise.then(function(){e.spinner=!1;var n=[["Period","Local","Total","Personal"]];angular.forEach(a.total,function(e,t){angular.forEach(a.local,function(r,i){i===t&&angular.forEach(a.my_measurements,function(i,a){a===t&&n.push([a,r,e,i])})})}),e.trend=google.visualization.arrayToDataTable(n)}),e.filterSource=function(e){var n={};return angular.forEach(e,function(e,t){t!=o.gmaNamespace&&"total"!=t&&(n[t]=e)}),n},e.save=function(){e.spinner=!0;var r=[];angular.forEach(["local","person"],function(n){e.editForm.hasOwnProperty(n)&&e.editForm[n].$dirty&&"undefined"!=typeof e.editForm[n]&&r.push({period:e.current.period.format("YYYY-MM"),mcc:e.current.mcc+"_"+o.gmaNamespace,measurement_type_id:e.details.measurement_type_ids[n],related_entity_id:"local"==n?e.current.assignment.ministry_id:e.current.assignment.id,value:e.editForm[n].$modelValue})}),r.length>0?t.saveMeasurement({},r,function(){n.close()}):n.dismiss("cancel")},e.close=function(){n.dismiss("cancel")},e.approveSelfAssigned=function(e,n){var e=e;e.state="pending",r.saveAssignment({assignment_id:e.assignment_id},{team_role:n},function(){"blocked"==n?(e.state="blocked",e.blocked=!0):(e.success=!0,e.state="member")},function(){delete e.state})}}]),angular.module("app").controller("ReportsController",["$scope","$document","measurementService","settings",function(e,n,t){function r(e){var n=[],t=0;return angular.forEach(e,function(e){0!==e&&n.push(e)}),0===n.length?0:(n.length>4&&(n.sort(function(e,n){return e-n}),n.shift(),n.pop()),angular.forEach(n,function(e){t+=e}),Math.round(t/n.length*100)/100)}e.chart=new google.visualization.LineChart(document.getElementById("reports-chart")),e.table=new google.visualization.Table(document.getElementById("reports-table"));var i=_.debounce(function(){"undefined"!=typeof e.current.assignment&&"undefined"!=typeof e.current.period&&"undefined"!=typeof e.current.mcc&&(delete e.dataTable,e.current.isLoaded=!1,e.measurements=t.getMeasurements({ministry_id:e.current.assignment.ministry_id,mcc:e.current.mcc,period:e.current.period.format("YYYY-MM"),historical:!0},function(){e.current.isLoaded=!0;var n=new google.visualization.DataTable,t=new google.visualization.DataTable,i=[];n.addColumn("string","Date"),angular.forEach(e.dates,function(t,r){i[r]=[t],angular.forEach(e.measurements,function(e){0===r&&n.addColumn("number",e.name),i[r].push(e.total[t])})}),n.addRows(i),e.dataTable=n,t.addColumn("string","Measurement"),angular.forEach(e.measurements,function(n,i){var a=[];angular.forEach(e.dates,function(e){0===i&&t.addColumn("number",e),a.push(n.total[e])}),0===i&&t.addColumn("number","Total"),t.addRow([n.name].concat(a,[r(a)]))}),e.tableDataTable=t},function(){}))},100);e.$watch("current.assignment.ministry_id",function(){i()}),e.$watch("current.mcc",function(){i()}),e.$watch("current.period",function(n){if("undefined"!=typeof n){i();for(var t=n.clone(),r=[],a=0;12>a;a++)r.push(t.clone().format("YYYY-MM")),t.subtract(1,"M");e.dates=r.reverse()}}),e.$watch("dataTable",function(n){"undefined"!=typeof n&&e.chart.draw(n,{chartArea:{top:20,left:50,width:"80%",height:"90%"},legend:{alignment:"start",position:"right"},orientation:"horizontal"})}),e.$watch("tableDataTable",function(n){"undefined"!=typeof n&&e.table.draw(n,{})})}]),angular.module("app").factory("assignmentService",["$resource","settings",function(e,n){return e(n.api.measurements("/assignments/:assignment_id"),{assignment_id:"@assignment_id"},{getAssignment:{method:"GET"},getAssignments:{method:"GET",isArray:!0},saveAssignment:{method:"PUT"},addTeamMember:{method:"POST"}})}]),angular.module("app").factory("churchService",["$resource","settings",function(e,n){return e(n.api.measurements("/churches/:church_id"),{},{getChurch:{method:"GET"},getChurches:{method:"GET",isArray:!0},addChurch:{method:"POST"},saveChurch:{method:"PUT",params:{church_id:"@id"}}})}]),angular.module("app").factory("measurementService",["$resource","settings",function(e,n){return e(n.api.measurements("/measurements/:measurement_id"),{},{getMeasurement:{method:"GET"},getMeasurements:{method:"GET",isArray:!0,params:{source:n.gmaNamespace}},saveMeasurement:{method:"POST"}})}]),angular.module("app").factory("measurementTypeService",["$resource","settings",function(e,n){return e(n.api.measurements("/measurement_types/:measurement_type_id"),{},{getMeasurementType:{method:"GET"},getMeasurementTypes:{method:"GET",isArray:!0},saveMeasurementType:{method:"PUT"},addMeasurementType:{method:"POST"}})
}]),angular.module("app").factory("ministryService",["$resource","settings",function(e,n){return e(n.api.measurements("/ministries/:ministry_id"),{},{getMinistry:{method:"GET"},getMinistries:{method:"GET",isArray:!0},updateMinistry:{method:"PUT",params:{ministry_id:"@ministry_id"}},createMinistry:{method:"POST"}})}]),angular.module("app").factory("sessionService",["$rootScope","$injector","$q","$location","settings","$log",function(e,n,t,r,i,a){var o,s=function(t){return"false"===t?(window.location=i.api.login,!1):n.get("$http").get(i.api.measurements("/token"),{params:{st:t}}).then(function(n){return e.current.user=n.data.user,e.current.sessionToken=n.data.session_ticket,o=n.data.session_ticket,"object"==typeof n.data.assignments?e.current.assignments=n.data.assignments:delete e.current.assignments,e.$broadcast("sessionStart",n.data),n.data})};return{startSession:function(e){s(e)},logout:function(){return n.get("$http")["delete"](i.api.measurements("/token"))},request:function(e){return-1!==e.url.indexOf(i.api.measurements())&&(e.withCredentials=!0,"undefined"!=typeof o&&(e.headers.Authorization="Bearer "+o),e.attempts="number"==typeof e.attempts?e.attempts+1:1),e},responseError:function(e){if(401==e.status&&-1!==e.config.url.indexOf(i.api.measurements())&&e.config.attempts<2){a.debug(e);var r=t.defer();return n.get("$http").get(i.api.refresh,{withCredentials:!0}).then(function(t){t.data?s(t.data.service_ticket).then(function(){n.get("$http")(e.config).then(function(e){r.resolve(e)},function(){r.reject()})}):r.reject()},function(){r.reject()}),r.promise}return t.reject(e)}}}]),angular.module("app").factory("trainingService",["$http","settings",function(e,n){function t(e){var n=0;if(!e)return 0;for(var t=0;t<e.length;t++)e[t].phase>(n||0)&&(n=e[t].phase);return n}function r(e){for(var n=0,t=0;t<e.length;t++)e[t].number_completed>(n||0)&&(n=e[t].number_completed);return n}return{getTrainings:function(i,a,o,s,c){return e.get(n.api.measurements("/training"),{params:{ministry_id:a,show_all:s,show_tree:c,mcc:o}}).then(function(e){return angular.forEach(e.data,function(e){e.current_stage=t(e.gcm_training_completions)+1,e.leaders_trained=r(e.gcm_training_completions),e.editMode=!1}),e.data})},updateTraining:function(t,r){var i=r.hasOwnProperty("Id")?r.Id:r.id;return e.put(n.api.measurements("/training/"+i),r).then(function(e){return e.data})},addTraining:function(t,r){return e.post(n.api.measurements("/training"),r).then(function(e){return e.data})},deleteTraining:function(t,r){var i=r.hasOwnProperty("Id")?r.Id:r.id;return e["delete"](n.api.measurements("/training/"+i)).then(function(){})},addTrainingCompletion:function(t,r){return e.post(n.api.measurements("/training_completion"),r).then(function(e){return e.data})},updateTrainingCompletion:function(t,r){var i=r.hasOwnProperty("Id")?r.Id:r.id;return e.put(n.api.measurements("/training_completion/"+i),r).then(function(e){return e.data})},deleteTrainingCompletion:function(t,r){var i=r.hasOwnProperty("Id")?r.Id:r.id;return e["delete"](n.api.measurements("/training_completion/"+i)).then(function(){})}}}]);